<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Evento - {{ event.nombre }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .chat-container { display: flex; gap: 20px; }
        .chat-panel { flex: 2; background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .map-panel { flex: 1; background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 350px; }
        #chatHistory { height: 350px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; padding: 10px; background: #fafafa; }
        #map { height: 350px; width: 100%; border-radius: 8px; }
        .message { margin-bottom: 10px; }
        .message .meta { font-size: 12px; color: #888; }
        .message .content { font-size: 15px; }
        .message.location { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 5px 10px; border-radius: 4px; }
        .indicativo-select { margin-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group select {
            width: 90%; /* O el ancho que prefieras */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Para que padding no afecte el width total */
        }

        .deleted-incident td {
            text-decoration: line-through;
            color: #95a5a6;
            background-color: #f8f9fa; /* Un fondo ligeramente diferente */
        }
        
        /* Estilos para estados de incidentes */
        .incident-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .incident-status:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .incident-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        /* Colores por estado */
        .status-pre-incidente {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status-pre-incidente .status-dot {
            background-color: #f39c12;
        }
        
        .status-activo {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-activo .status-dot {
            background-color: #e74c3c;
        }
        
        .status-stand-by {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-stand-by .status-dot {
            background-color: #17a2b8;
        }
        
        .status-solucionado {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-solucionado .status-dot {
            background-color: #28a745;
        }
        
        /* Clases comunes para modales de cambio de estado */
        .status-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .status-modal-content {
            background: #fff;
            border-radius: 8px;
            max-width: 300px;
            width: 95vw;
            margin: auto;
            padding: 15px;
            position: relative;
        }
        
        .status-modal-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .status-modal-title {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: bold;
        }
        
        .status-modal-info {
            color: #666;
            margin-bottom: 15px;
            font-size: 13px;
            white-space: pre-line;
        }
        
        .status-buttons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .status-btn {
            padding: 10px 6px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            font-size: 11px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .status-btn:hover {
            transform: scale(1.02);
        }
        
        /* Colores espec√≠ficos para estados de incidente */
        .status-btn[data-status="pre-incidente"] {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
        
        .status-btn[data-status="activo"] {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        
        .status-btn[data-status="stand-by"] {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        
        .status-btn[data-status="solucionado"] {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        
        /* Colores espec√≠ficos para estados de asignaci√≥n */
        .status-btn[data-status="pre-avisado"] {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
        
        .status-btn[data-status="avisado"] {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        
        .status-btn[data-status="en camino"] {
            background: #e2e3e5;
            color: #383d41;
            border-color: #d6d8db;
        }
        
        .status-btn[data-status="en el lugar"] {
            background: #cce5ff;
            color: #004085;
            border-color: #99d6ff;
        }
        
        .status-btn[data-status="finalizado"] {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        
        /* Estado activo/resaltado */
        .status-btn.current-status {
            border-width: 4px !important;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3), inset 0 0 0 2px rgba(255,255,255,0.8) !important;
            transform: scale(1.08) !important;
            font-weight: 900 !important;
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Control de Evento: {{ event.nombre }}</h1>
        <a href="/events/" style="color:white;">‚Üê Volver a Eventos</a>
    </div>
    <div class="chat-container">
        <div class="chat-panel">
            <div class="indicativo-select">
                <label for="indicativoSelect"><b>Selecciona tu indicativo:</b></label>
                <select id="indicativoSelect">
                    <option value="">-- Elige un indicativo --</option>
                    {% for ind in indicativos %}
                        <option value="{{ ind.id }}">{{ ind.indicativo }} ({{ ind.nombre or '' }})</option>
                    {% endfor %}
                </select>
            </div>
            <div id="chatHistory"></div>
            <form id="chatForm" style="display:flex; gap:5px;">
                <input type="text" id="chatInput" placeholder="Escribe un mensaje..." style="flex:1; padding:8px;">
                <select id="toIndicativoSelect" style="width:140px;">
                    <option value="">Para: Todos</option>
                    {% for ind in indicativos %}
                        <option value="{{ ind.id }}">Para: {{ ind.indicativo }} ({{ ind.nombre or '' }})</option>
                    {% endfor %}
                </select>
                <button type="submit">Enviar</button>
                <button type="button" id="sendLocationBtn">üìç</button>
                <button type="button" id="assignServiceBtn" title="Asignar servicio">üõ†Ô∏è</button>
            </form>
        </div>
        <div class="map-panel">
            <h3>Localizaciones</h3>
            <div style="position:relative;">
                <button id="fitMarkersBtn" title="Centrar mapa" class="leaflet-control leaflet-bar" style="position:absolute;top:10px;right:10px;z-index:1001;width:34px;height:34px;line-height:32px;font-size:20px;padding:0;display:flex;align-items:center;justify-content:center;">
                    üß≠
                </button>
                <div id="map"></div>
            </div>
        </div>
    </div>
    <!-- Modal de ubicaci√≥n manual -->
    <div id="locationModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:8px; max-width:500px; width:95vw; margin:40px auto; padding:20px; position:relative;">
            <button id="closeLocationModal" style="position:absolute; top:10px; right:10px; background:#e74c3c; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:18px; cursor:pointer;">&times;</button>
            <h2>Enviar ubicaci√≥n manualmente</h2>
            <div style="margin-bottom:10px;">
                <label><b>Buscar direcci√≥n:</b></label>
                <input type="text" id="addressInput" placeholder="Ej: Pla√ßa Catalunya, Barcelona" style="width:80%;">
                <button type="button" id="searchAddressBtn">Buscar</button>
            </div>
            <div style="margin-bottom:10px;">
                <label><b>Latitud:</b></label>
                <input type="number" id="latInput" step="any" style="width:40%;">
                <label><b>Longitud:</b></label>
                <input type="number" id="lngInput" step="any" style="width:40%;">
            </div>
            <div id="manualMap" style="height:250px; width:100%; margin-bottom:10px; border-radius:8px;"></div>
            <button type="button" id="sendManualLocationBtn" style="background:#8e44ad; color:#fff; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">Enviar ubicaci√≥n</button>
        </div>
    </div>
    <!-- Modal de asignar servicio -->
    <div id="assignServiceModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:8px; max-width:520px; width:95vw; margin:40px auto; padding:20px; position:relative;">
            <button id="closeAssignServiceModal" style="position:absolute; top:10px; right:10px; background:#e74c3c; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:18px; cursor:pointer;">&times;</button>
            <h2>Asignar servicio</h2>
            <div style="margin-bottom:10px;">
                <label><b>Asignar a:</b></label>
                <select id="assignToIndicativoSelect" style="width:90%;">
                    <option value="">-- Selecciona un indicativo --</option>
                    {% for ind in indicativos %}
                        <option value="{{ ind.id }}">{{ ind.indicativo }} ({{ ind.nombre or '' }})</option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-bottom:10px;">
                <label><b>Descripci√≥n del servicio:</b></label>
                <input type="text" id="assignServiceText" placeholder="Ej: Controlar acceso, patrullar zona..." style="width:90%;">
            </div>
            <div id="assignServiceMap" style="height:250px; width:100%; margin-bottom:10px; border-radius:8px;"></div>
            <div style="margin-bottom:10px;">
                <label><b>Latitud:</b></label>
                <input type="number" id="assignLatInput" step="any" style="width:40%;">
                <label><b>Longitud:</b></label>
                <input type="number" id="assignLngInput" step="any" style="width:40%;">
            </div>
            <button type="button" id="sendAssignServiceBtn" style="background:#27ae60; color:#fff; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">Asignar servicio</button>
        </div>
    </div>
    <!-- Gesti√≥n de incidentes -->
    <div class="incidents-container" style="background:#fff; padding:20px; border-radius:8px; margin-top:30px; box-shadow:0 2px 4px rgba(0,0,0,0.08);">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px;">
            <h2>Incidentes</h2>
            <div>
                <label for="showDeletedIncidents" style="margin-right: 10px; font-weight:normal;">
                    <input type="checkbox" id="showDeletedIncidents" style="margin-right:5px;">
                    Mostrar eliminados
                </label>
                <button id="addIncidentBtn" style="background:#e67e22; color:#fff; padding:8px 18px; border:none; border-radius:4px; font-size:15px; cursor:pointer;">+ Nuevo incidente</button>
            </div>
        </div>
        
        <!-- Controles de b√∫squeda y filtros -->
        <div style="background:#f8f9fa; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #e9ecef;">
            <div style="display:grid; grid-template-columns: 1fr 200px 200px auto; gap:10px; align-items:end;">
                <!-- Buscador general -->
                <div>
                    <label for="incidentSearch" style="display:block; margin-bottom:5px; font-weight:bold; font-size:14px;">üîç Buscar en incidentes:</label>
                    <input type="text" id="incidentSearch" placeholder="Buscar por ID, tipo, descripci√≥n, reportado por, ubicaci√≥n..." style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
                </div>
                
                <!-- Filtro por estado -->
                <div>
                    <label for="statusFilter" style="display:block; margin-bottom:5px; font-weight:bold; font-size:14px;">Estado:</label>
                    <select id="statusFilter" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
                        <option value="">Todos los estados</option>
                        <option value="pre-incidente">Pre-incidente</option>
                        <option value="activo">Activo</option>
                        <option value="stand-by">Stand-by</option>
                        <option value="solucionado">Solucionado</option>
                    </select>
                </div>
                
                <!-- Filtro por tipo -->
                <div>
                    <label for="typeFilter" style="display:block; margin-bottom:5px; font-weight:bold; font-size:14px;">Tipo:</label>
                    <select id="typeFilter" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
                        <option value="">Todos los tipos</option>
                        <option value="üöë Asistencia M√©dica">üöë Asistencia M√©dica</option>
                        <option value="üöß Incidencia Circuito">üöß Incidencia Circuito</option>
                        <option value="üë• Apoyo al Compa√±ero">üë• Apoyo al Compa√±ero</option>
                        <option value="üë• Afluencia Excesiva">üë• Afluencia Excesiva</option>
                        <option value="üî• Incendio">üî• Incendio</option>
                        <option value="üíß Fuga de Agua/Inundaci√≥n">üíß Fuga de Agua/Inundaci√≥n</option>
                        <option value="üõ†Ô∏è Aver√≠a T√©cnica">üõ†Ô∏è Aver√≠a T√©cnica</option>
                        <option value="üó£Ô∏è Altercado/Discusi√≥n">üó£Ô∏è Altercado/Discusi√≥n</option>
                        <option value="‚ùì Otro (General)">‚ùì Otro (General)</option>
                    </select>
                </div>
                
                <!-- Bot√≥n limpiar filtros -->
                <div>
                    <button id="clearFiltersBtn" style="background:#6c757d; color:#fff; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-size:14px;" title="Limpiar todos los filtros">üóëÔ∏è Limpiar</button>
                </div>
            </div>
            
            <!-- Controles de ordenaci√≥n -->
            <div style="margin-top:10px; padding-top:10px; border-top:1px solid #dee2e6;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <span style="font-weight:bold; font-size:14px;">üìä Ordenar por:</span>
                    <select id="sortField" style="padding:6px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
                        <option value="incident_number">ID</option>
                        <option value="tipo">Tipo</option>
                        <option value="estado">Estado</option>
                        <option value="descripcion">Descripci√≥n</option>
                        <option value="reportado_por">Reportado por</option>
                        <option value="direccion_formateada">Ubicaci√≥n</option>
                        <option value="created_at">Fecha creaci√≥n</option>
                    </select>
                    <select id="sortOrder" style="padding:6px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
                        <option value="asc">‚¨ÜÔ∏è Ascendente</option>
                        <option value="desc">‚¨áÔ∏è Descendente</option>
                    </select>
                    <span id="incidentCount" style="margin-left:auto; color:#666; font-size:14px; font-weight:bold;"></span>
                </div>
            </div>
        </div>
        <table id="incidentsTable" style="width:100%; margin-top:15px; border-collapse:collapse;">
            <thead>
                <tr style="background:#f8f9fa;">
                    <th>ID</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Descripci√≥n</th>
                    <th>Reportado por</th>
                    <th>Localizaci√≥n</th>
                    <th>Asignados Activos</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="incidentsTableBody"></tbody>
        </table>
    </div>
    <!-- Modal de incidente -->
    <div id="incidentModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:2000; overflow-y:auto; padding:20px 0;">
        <div style="background:#fff; border-radius:8px; max-width:540px; width:95vw; margin:0 auto; padding:20px; position:relative; max-height:calc(100vh - 40px); overflow-y:auto;">
            <button id="closeIncidentModal" style="position:absolute; top:10px; right:10px; background:#e74c3c; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:18px; cursor:pointer;">&times;</button>
            <h2 id="incidentModalTitle">Nuevo incidente</h2>
            <form id="incidentForm">
                <div class="form-group">
                    <label for="incidentTipo">Tipo de incidente:</label>
                    <select id="incidentTipo" name="tipo" required style="width:90%;">
                        <option value="">-- Selecciona tipo de incidente --</option>
                        <option value="üöë Asistencia M√©dica">üöë Asistencia M√©dica</option>
                        <option value="üöß Incidencia Circuito">üöß Incidencia Circuito</option>
                        <option value="üë• Apoyo al Compa√±ero">üë• Apoyo al Compa√±ero</option>
                        <option value="üë• Afluencia Excesiva">üë• Afluencia Excesiva</option>
                        <option value="üî• Incendio">üî• Incendio</option>
                        <option value="üíß Fuga de Agua/Inundaci√≥n">üíß Fuga de Agua/Inundaci√≥n</option>
                        <option value="üõ†Ô∏è Aver√≠a T√©cnica">üõ†Ô∏è Aver√≠a T√©cnica</option>
                        <option value="üó£Ô∏è Altercado/Discusi√≥n">üó£Ô∏è Altercado/Discusi√≥n</option>
                        <option value="‚ùì Otro (General)">‚ùì Otro (General)</option>
                        <option value="Otro">üîß Otro (especificar)</option>
                    </select>
                </div>
                <div class="form-group" id="tipoOtroGroup" style="display:none;">
                    <label for="incidentTipoOtro">Especifica el tipo de incidente:</label>
                    <input type="text" id="incidentTipoOtro" name="tipo_otro" style="width:90%;" placeholder="Describe el tipo de incidente...">
                </div>
                <div class="form-group" id="dorsalGroup" style="display:none;">
                    <label for="incidentDorsal">Dorsal:</label>
                    <input type="text" id="incidentDorsal" name="dorsal" style="width:90%;">
                </div>
                <div class="form-group" id="patologiaGroup" style="display:none;">
                    <label for="incidentPatologia">Patolog√≠a:</label>
                    <input type="text" id="incidentPatologia" name="patologia" style="width:90%;">
                </div>
                <div class="form-group">
                    <label for="incidentDescripcion">Descripci√≥n:</label>
                    <input type="text" id="incidentDescripcion" name="descripcion" style="width:90%;">
                </div>
                <div class="form-group">
                    <label for="incidentReportadoPor">Reportado por:</label>
                    <select id="incidentReportadoPor" name="reportado_por" style="width:90%;">
                        <option value="">-- Selecciona qui√©n reporta --</option>
                        <option value="CME">CME</option>
                        <option value="GUB">GUB</option>
                        <option value="Servicios M√©dicos">Servicios M√©dicos</option>
                        <option value="P√∫blico">P√∫blico</option>
                        <option value="Seguridad">Seguridad</option>
                        {% for ind in indicativos %}
                            <option value="{{ ind.indicativo ~ (' (' ~ ind.nombre ~ ')' if ind.nombre else '') }}">{{ ind.indicativo ~ (' (' ~ ind.nombre ~ ')' if ind.nombre else '') }}</option>
                        {% endfor %}
                        <option value="Otro">Otro (especificar)</option>
                    </select>
                </div>
                <div class="form-group" id="reportadoOtroGroup" style="display:none;">
                    <label for="incidentReportadoOtro">Especifica qui√©n reporta:</label>
                    <input type="text" id="incidentReportadoOtro" name="reportado_otro" style="width:90%;" placeholder="Nombre o descripci√≥n de qui√©n reporta...">
                </div>
                <div class="form-group">
                    <label>Localizaci√≥n:</label>
                    <div style="margin-bottom:10px;">
                        <input type="text" id="incidentAddressSearchInput" placeholder="Buscar direcci√≥n..." style="width:70%; margin-right:5px;">
                        <button type="button" id="incidentSearchAddressBtn" style="padding:8px 10px;">Buscar</button>
                    </div>
                    <div id="incidentMap" style="height:200px; width:100%; border-radius:8px; margin-bottom:8px;"></div>
                    <div id="incidentAddressDisplay" style="font-size:0.9em; color:#555; margin-bottom:8px; min-height:1.2em;"></div>
                    <div style="margin-bottom:10px;">
                        <label for="incidentInfoUbicacion" style="display:block; margin-bottom:5px; font-weight:bold;">Informaci√≥n adicional de ubicaci√≥n:</label>
                        <input type="text" id="incidentInfoUbicacion" name="info_ubicacion" style="width:90%;" placeholder="Ej: Cerca del escenario principal, Entrada VIP, Zona de food trucks...">
                    </div>
                    <button type="button" id="showCoordsBtn" style="background:#6c757d; color:#fff; padding:6px 12px; border:none; border-radius:4px; font-size:12px; cursor:pointer;">‚öôÔ∏è Coordenadas Avanzadas</button>
                    <!-- Campos ocultos para lat/lng -->
                    <input type="hidden" id="incidentLat" name="lat">
                    <input type="hidden" id="incidentLng" name="lng">
                </div>
                <div class="form-group">
                    <label for="incidentEstado">Estado:</label>
                    <div class="status-buttons-grid" style="margin-top: 8px;">
                        <button type="button" class="status-btn incident-status-btn" data-status="pre-incidente">
                            <div>üü°</div>
                            <div>Pre-incidente</div>
                        </button>
                        
                        <button type="button" class="status-btn incident-status-btn" data-status="activo">
                            <div>üî¥</div>
                            <div>Activo</div>
                        </button>
                        
                        <button type="button" class="status-btn incident-status-btn" data-status="stand-by">
                            <div>üîµ</div>
                            <div>Stand-by</div>
                        </button>
                        
                        <button type="button" class="status-btn incident-status-btn" data-status="solucionado">
                            <div>üü¢</div>
                            <div>Solucionado</div>
                        </button>
                    </div>
                    <input type="hidden" id="incidentEstado" name="estado" value="activo">
                </div>
                <button type="submit" style="background:#27ae60; color:#fff; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">Guardar</button>
            </form>
        </div>
    </div>
    
    <!-- Modal de cambio r√°pido de estado -->
    <div id="statusChangeModal" class="status-modal">
        <div class="status-modal-content">
            <button id="closeStatusModal" class="status-modal-close">&times;</button>
            <h4 id="statusModalTitle" class="status-modal-title">Cambiar Estado del Incidente</h4>
            <p id="statusModalIncidentInfo" class="status-modal-info"></p>
            
            <div class="status-buttons-grid">
                <button class="status-btn status-change-btn" data-status="pre-incidente">
                    <div>üü°</div>
                    <div>Pre-incidente</div>
                </button>
                
                <button class="status-btn status-change-btn" data-status="activo">
                    <div>üî¥</div>
                    <div>Activo</div>
                </button>
                
                <button class="status-btn status-change-btn" data-status="stand-by">
                    <div>üîµ</div>
                    <div>Stand-by</div>
                </button>
                
                <button class="status-btn status-change-btn" data-status="solucionado">
                    <div>üü¢</div>
                    <div>Solucionado</div>
                </button>
            </div>
        </div>
    </div>
     
     <!-- Modal de coordenadas avanzadas -->
     <div id="coordsModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:2100; overflow-y:auto; padding:20px 0;">
         <div style="background:#fff; border-radius:8px; max-width:450px; width:95vw; margin:0 auto; padding:20px; position:relative; max-height:calc(100vh - 40px); overflow-y:auto;">
             <button id="closeCoordsModal" style="position:absolute; top:10px; right:10px; background:#e74c3c; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:18px; cursor:pointer;">&times;</button>
             <h3>Coordenadas Avanzadas</h3>
             <p style="color:#666; font-size:14px; margin-bottom:15px;">Ajusta manualmente las coordenadas del incidente si es necesario.</p>
             
             <div style="margin-bottom:15px;">
                 <label for="coordsLatInput" style="display:block; margin-bottom:5px; font-weight:bold;">Latitud:</label>
                 <input type="number" id="coordsLatInput" step="any" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="Ej: 41.3874">
             </div>
             
             <div style="margin-bottom:15px;">
                 <label for="coordsLngInput" style="display:block; margin-bottom:5px; font-weight:bold;">Longitud:</label>
                 <input type="number" id="coordsLngInput" step="any" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="Ej: 2.1686">
             </div>
             
             <div style="margin-bottom:15px;">
                 <small style="color:#666;">
                     üí° <strong>Tip:</strong> Tambi√©n puedes hacer clic en el mapa principal para establecer las coordenadas autom√°ticamente.
                 </small>
             </div>
             
             <div style="display:flex; gap:10px; justify-content:flex-end;">
                 <button type="button" id="clearCoordsBtn" style="background:#6c757d; color:#fff; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;">Limpiar</button>
                 <button type="button" id="applyCoordsBtn" style="background:#007bff; color:#fff; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;">Aplicar</button>
             </div>
         </div>
     </div>
     
     <!-- Modal de asignaci√≥n de incidentes -->
     <div id="assignIncidentModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:2100; overflow-y:auto; padding:20px 0;">
         <div style="background:#fff; border-radius:8px; max-width:600px; width:95vw; margin:0 auto; padding:20px; position:relative; max-height:calc(100vh - 40px); overflow-y:auto;">
             <button id="closeAssignIncidentModal" style="position:absolute; top:10px; right:10px; background:#e74c3c; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:18px; cursor:pointer;">&times;</button>
             <h2 id="assignIncidentModalTitle">Asignar Incidente</h2>
             <p id="assignIncidentInfo" style="color:#666; margin-bottom:20px;"></p>
             
             <div style="margin-bottom:20px;">
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                     <h3 style="margin:0;">Asignaciones Actuales:</h3>
                     <div id="batchControls" style="display:none;">
                         <button id="selectAllBtn" style="background:#6c757d; color:#fff; border:none; padding:4px 8px; border-radius:3px; cursor:pointer; margin-right:5px; font-size:12px;">Seleccionar Todo</button>
                         <button id="deselectAllBtn" style="background:#6c757d; color:#fff; border:none; padding:4px 8px; border-radius:3px; cursor:pointer; font-size:12px;">Deseleccionar</button>
                     </div>
                 </div>
                 <div id="currentAssignments" style="background:#f8f9fa; padding:10px; border-radius:6px; min-height:40px;">
                     <em style="color:#666;">Cargando asignaciones...</em>
                 </div>
                 
                 <!-- Controles de cambio en batch -->
                 <div id="batchStatusControls" style="display:none; margin-top:15px; padding:15px; background:#e9ecef; border-radius:6px; border:1px solid #dee2e6;">
                     <h4 style="margin:0 0 10px 0; color:#495057;">Cambio de Estado en Lote:</h4>
                     <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:8px;">
                         <button class="batch-status-btn" data-status="pre-avisado" style="padding:8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#fff3cd; color:#856404; border:2px solid #ffeaa7; font-size:11px;">
                             üîî Pre-avisado
                         </button>
                         <button class="batch-status-btn" data-status="avisado" style="padding:8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#d1ecf1; color:#0c5460; border:2px solid #bee5eb; font-size:11px;">
                             üì¢ Avisado
                         </button>
                         <button class="batch-status-btn" data-status="en camino" style="padding:8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#e2e3e5; color:#383d41; border:2px solid #d6d8db; font-size:11px;">
                             üöó En camino
                         </button>
                         <button class="batch-status-btn" data-status="en el lugar" style="padding:8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#cce5ff; color:#004085; border:2px solid #99d6ff; font-size:11px;">
                             üìç En el lugar
                         </button>
                         <button class="batch-status-btn" data-status="finalizado" style="padding:8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#d4edda; color:#155724; border:2px solid #c3e6cb; font-size:11px;">
                             ‚úÖ Finalizado
                         </button>
                     </div>
                     <div style="margin-top:10px; text-align:center;">
                         <small style="color:#666;">Selecciona las asignaciones arriba y luego elige el nuevo estado</small>
                     </div>
                 </div>
                 
                 <div style="border-top:1px solid #dee2e6; padding-top:20px;">
                     <h3 style="margin-bottom:15px;">Nueva Asignaci√≥n:</h3>
                     <form id="assignIncidentForm">
                         <div style="margin-bottom:15px;">
                             <label for="assignIndicativoSelect" style="display:block; margin-bottom:5px; font-weight:bold;">Asignar a:</label>
                             <select id="assignIndicativoSelect" required style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                 <option value="">-- Selecciona a qui√©n asignar --</option>
                                 <option value="CME">CME</option>
                                 <option value="GUB">GUB</option>
                                 <option value="Servicios M√©dicos">Servicios M√©dicos</option>
                                 <option value="Seguridad">Seguridad</option>
                                 {% for ind in indicativos %}
                                     <option value="{{ ind.indicativo ~ (' (' ~ ind.nombre ~ ')' if ind.nombre else '') }}">{{ ind.indicativo ~ (' (' ~ ind.nombre ~ ')' if ind.nombre else '') }}</option>
                                 {% endfor %}
                                 <option value="Otro">Otro (especificar)</option>
                             </select>
                         </div>
                         <div style="margin-bottom:15px;" id="assignOtroGroup" style="display:none;">
                             <label for="assignOtro" style="display:block; margin-bottom:5px; font-weight:bold;">Especifica a qui√©n asignar:</label>
                             <input type="text" id="assignOtro" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="Nombre o descripci√≥n de a qui√©n asignar...">
                         </div>
                         
                         <div style="margin-bottom:15px;">
                             <label for="assignStatusSelect" style="display:block; margin-bottom:5px; font-weight:bold;">Estado de la asignaci√≥n:</label>
                             <div class="status-buttons-grid" style="margin-top: 8px;">
                                 <button type="button" class="status-btn assignment-status-btn" data-status="pre-avisado">
                                     <div>üîî</div>
                                     <div>Pre-avisado</div>
                                 </button>
                                 
                                 <button type="button" class="status-btn assignment-status-btn" data-status="avisado">
                                     <div>üì¢</div>
                                     <div>Avisado</div>
                                 </button>
                                 
                                 <button type="button" class="status-btn assignment-status-btn" data-status="en camino">
                                     <div>üöó</div>
                                     <div>En camino</div>
                                 </button>
                                 
                                 <button type="button" class="status-btn assignment-status-btn" data-status="en el lugar">
                                     <div>üìç</div>
                                     <div>En el lugar</div>
                                 </button>
                                 
                                 <button type="button" class="status-btn assignment-status-btn" data-status="finalizado">
                                     <div>‚úÖ</div>
                                     <div>Finalizado</div>
                                 </button>
                             </div>
                             <input type="hidden" id="assignStatusSelect" name="estado_asignacion" value="avisado">
                         </div>
                         
                         <div style="display:flex; gap:10px; justify-content:flex-end;">
                             <button type="button" id="cancelAssignBtn" style="background:#6c757d; color:#fff; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">Cancelar</button>
                             <button type="submit" style="background:#28a745; color:#fff; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">Asignar</button>
                         </div>
                     </form>
                 </div>
             </div>
         </div>
     </div>
     
     <!-- Modal de cambio de estado de asignaci√≥n -->
     <div id="assignmentStatusModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:2200; overflow-y:auto; padding:20px 0;">
         <div style="background:#fff; border-radius:8px; max-width:300px; width:95vw; margin:auto; padding:12px; position:relative;">
             <button id="closeAssignmentStatusModal" style="position:absolute; top:6px; right:6px; background:#e74c3c; color:#fff; border:none; border-radius:50%; width:24px; height:24px; font-size:14px; cursor:pointer;">&times;</button>
             <h4 id="assignmentStatusModalTitle" style="margin:0 0 6px 0; font-size:14px; font-weight:bold;">Cambiar Estado</h4>
             <p id="assignmentStatusModalInfo" style="color:#666; margin-bottom:10px; font-size:12px;"></p>
             
             <div style="display:grid; grid-template-columns: 1fr; gap:6px;">
                 <button class="assignment-status-change-btn" data-status="pre-avisado" style="padding:8px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; background:#fff3cd; color:#856404; border:1px solid #ffeaa7; text-align:left; font-size:11px;">
                     <div style="display:flex; align-items:center;">
                         <div style="width:8px; height:8px; border-radius:50%; background:#f39c12; margin-right:6px;"></div>
                         üîî Pre-avisado
                     </div>
                 </button>
                 
                 <button class="assignment-status-change-btn" data-status="avisado" style="padding:8px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; text-align:left; font-size:11px;">
                     <div style="display:flex; align-items:center;">
                         <div style="width:8px; height:8px; border-radius:50%; background:#17a2b8; margin-right:6px;"></div>
                         üì¢ Avisado
                     </div>
                 </button>
                 
                 <button class="assignment-status-change-btn" data-status="en camino" style="padding:8px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; background:#e2e3e5; color:#383d41; border:1px solid #d6d8db; text-align:left; font-size:11px;">
                     <div style="display:flex; align-items:center;">
                         <div style="width:8px; height:8px; border-radius:50%; background:#6c757d; margin-right:6px;"></div>
                         üöó En camino
                     </div>
                 </button>
                 
                 <button class="assignment-status-change-btn" data-status="en el lugar" style="padding:8px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; background:#cce5ff; color:#004085; border:1px solid #99d6ff; text-align:left; font-size:11px;">
                     <div style="display:flex; align-items:center;">
                         <div style="width:8px; height:8px; border-radius:50%; background:#007bff; margin-right:6px;"></div>
                         üìç En el lugar
                     </div>
                 </button>
                 
                 <button class="assignment-status-change-btn" data-status="finalizado" style="padding:8px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; background:#d4edda; color:#155724; border:1px solid #c3e6cb; text-align:left; font-size:11px;">
                     <div style="display:flex; align-items:center;">
                         <div style="width:8px; height:8px; border-radius:50%; background:#28a745; margin-right:6px;"></div>
                         ‚úÖ Finalizado
                     </div>
                 </button>
             </div>
         </div>
     </div>
     
     <!-- Modal r√°pido de cambio de estado de asignaci√≥n -->
     <div id="quickAssignmentStatusModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:2300; overflow-y:auto; padding:20px 0;">
         <div style="background:#fff; border-radius:8px; max-width:400px; width:95vw; margin:auto; padding:20px; position:relative; max-height:calc(100vh - 40px); overflow-y:auto;">
             <button onclick="document.getElementById('quickAssignmentStatusModal').style.display='none'; currentAssignmentForStatusChange=null;" style="position:absolute; top:10px; right:10px; background:#e74c3c; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:18px; cursor:pointer;">&times;</button>
             <h2 id="quickAssignmentStatusTitle">Cambiar Estado de Asignaci√≥n</h2>
             <p id="quickAssignmentStatusInfo" style="color:#666; margin-bottom:20px;"></p>
             
             
             <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                 <button class="quick-status-btn" data-status="pre-avisado" onclick="changeAssignmentStatusQuick('pre-avisado')" style="padding:12px 8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#fff3cd; color:#856404; border:2px solid #ffeaa7; text-align:center; font-size:12px;">
                     <div>üîî</div>
                     <div>Pre-avisado</div>
                 </button>
                 
                 <button class="quick-status-btn" data-status="avisado" onclick="changeAssignmentStatusQuick('avisado')" style="padding:12px 8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#d1ecf1; color:#0c5460; border:2px solid #bee5eb; text-align:center; font-size:12px;">
                     <div>üì¢</div>
                     <div>Avisado</div>
                 </button>
                 
                 <button class="quick-status-btn" data-status="en camino" onclick="changeAssignmentStatusQuick('en camino')" style="padding:12px 8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#e2e3e5; color:#383d41; border:2px solid #d6d8db; text-align:center; font-size:12px;">
                     <div>üöó</div>
                     <div>En camino</div>
                 </button>
                 
                 <button class="quick-status-btn" data-status="en el lugar" onclick="changeAssignmentStatusQuick('en el lugar')" style="padding:12px 8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#cce5ff; color:#004085; border:2px solid #99d6ff; text-align:center; font-size:12px;">
                     <div>üìç</div>
                     <div>En el lugar</div>
                 </button>
                 
                 <button class="quick-status-btn" data-status="finalizado" onclick="changeAssignmentStatusQuick('finalizado')" style="padding:12px 8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#d4edda; color:#155724; border:2px solid #c3e6cb; text-align:center; font-size:12px; grid-column: 1 / -1;">
                     <div>‚úÖ</div>
                     <div>Finalizado</div>
                 </button>
             </div>
         </div>
     </div>
</div>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const eventId = {{ event.id }};
const eventZona = "{{ event.zona_evento | default('') }}"; // Leer zona_evento del evento

const indicativoKey = `rcq_indicativo_${eventId}`;
let indicativoId = localStorage.getItem(indicativoKey) || '';
const indicativoSelect = document.getElementById('indicativoSelect');
indicativoSelect.value = indicativoId;
indicativoSelect.addEventListener('change', function() {
    indicativoId = this.value;
    if (indicativoId) localStorage.setItem(indicativoKey, indicativoId);
});
// Socket.IO
let socket = null;
let joined = false;
const chatHistory = document.getElementById('chatHistory');
// --- MAPA DE LOCALIZACIONES: solo √∫ltima ubicaci√≥n de cada indicativo ---
const lastLocations = {}; // indicativo_id -> msg
const markerRefs = {}; // indicativo_id -> marker
let selectedMarker = null;

// Mapa principal de localizaciones
const map = L.map('map').setView([41.3874, 2.1686], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

// --- Auto-centro del mapa ---
let autoCenter = true;
let programmaticMoves = 0;

// Bot√≥n de auto-centro
const autoCenterBtn = document.createElement('button');
autoCenterBtn.id = 'autoCenterBtn';
autoCenterBtn.title = 'Activar/desactivar auto-centro';
autoCenterBtn.className = 'leaflet-control leaflet-bar';
autoCenterBtn.style.position = 'absolute';
autoCenterBtn.style.top = '54px';
autoCenterBtn.style.right = '10px';
autoCenterBtn.style.zIndex = 1001;
autoCenterBtn.style.width = '34px';
autoCenterBtn.style.height = '34px';
autoCenterBtn.style.lineHeight = '32px';
autoCenterBtn.style.fontSize = '20px';
autoCenterBtn.style.padding = '0';
autoCenterBtn.style.display = 'flex';
autoCenterBtn.style.alignItems = 'center';
autoCenterBtn.style.justifyContent = 'center';
autoCenterBtn.innerHTML = '<span id="autoCenterIcon">üéØ</span>';

document.querySelector('.map-panel > div').appendChild(autoCenterBtn);

function updateAutoCenterBtn() {
    autoCenterBtn.style.background = autoCenter ? '#27ae60' : '#eee';
    autoCenterBtn.style.color = autoCenter ? '#fff' : '#888';
    autoCenterBtn.title = autoCenter ? 'Auto-centro activado' : 'Auto-centro desactivado';
}
updateAutoCenterBtn();

autoCenterBtn.addEventListener('click', function() {
    autoCenter = !autoCenter;
    updateAutoCenterBtn();
    if (autoCenter) {
        programmaticMoves++;
        updateLocationMarkers(true);
    }
});

map.on('movestart zoomstart', function(e) {
    if (autoCenter && programmaticMoves === 0) {
        autoCenter = false;
        updateAutoCenterBtn();
    }
});
map.on('moveend zoomend', function(e) {
    if (programmaticMoves > 0) {
        programmaticMoves--;
    }
});

function updateLocationMarkers(autoFit = false) {
    // Limpiar marcadores
    Object.values(markerRefs).forEach(m => map.removeLayer(m));
    Object.keys(markerRefs).forEach(k => delete markerRefs[k]);
    const markerList = [];
    // A√±adir solo la √∫ltima ubicaci√≥n de cada indicativo
    Object.values(lastLocations).forEach(msg => {
        if (msg.content.type === 'location') {
            const color = msg.indicativo_color || '#3498db';
            const marker = L.marker([msg.content.lat, msg.content.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style=\"background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff;\"></div>`
                })
            }).addTo(map);
            marker.bindPopup(`<b>${msg.indicativo}</b><br>${msg.timestamp}`);
            markerRefs[msg.indicativo_id] = marker;
            markerList.push(marker);
        }
    });
    // Centrar mapa si se solicita y hay marcadores
    if (autoFit && markerList.length > 0) {
        programmaticMoves++;
        if (markerList.length === 1) {
            map.setView(markerList[0].getLatLng(), 15);
        } else {
            const group = L.featureGroup(markerList);
            map.fitBounds(group.getBounds().pad(0.2));
        }
    }
}

// --- Lista de indicativos para lookup r√°pido por id ---
const indicativosList = {{ indicativos | tojson }};

function appendMessage(msg) {
    const div = document.createElement('div');
    div.className = 'message' + (msg.content.type === 'location' ? ' location' : '');
    const color = msg.indicativo_color || '#3498db';
    let privado = '';
    let destinatario = 'Todos';
    if (msg.to_indicativo_id && msg.to_indicativo_id !== '' && msg.to_indicativo_id !== null) {
        // Buscar el nombre del destinatario en la lista de indicativos
        const dest = indicativosList.find(i => i.id == msg.to_indicativo_id);
        destinatario = dest ? (dest.indicativo + (dest.nombre ? ' (' + dest.nombre + ')' : '')) : msg.to_indicativo_id;
        privado = '<span style="color:#e67e22;font-size:12px;margin-left:6px;">(privado)</span>';
    }
    div.innerHTML = `<div class=\"meta\"><span style=\"display:inline-block;width:13px;height:13px;border-radius:50%;background:${color};border:1.5px solid #ccc;margin-right:5px;vertical-align:middle;\"></span><b>${msg.indicativo || ''}</b> ‚Üí <b>${destinatario}</b> <span>${msg.timestamp}</span> ${privado}</div>`;
    if (msg.content.type === 'text') {
        div.innerHTML += `<div class=\"content\">${msg.content.text}</div>`;
    } else if (msg.content.type === 'location') {
        div.innerHTML += `<div class=\"content\">üìç Ubicaci√≥n: (${msg.content.lat}, ${msg.content.lng})</div>`;
        lastLocations[msg.indicativo_id] = {
            ...msg,
            indicativo_color: msg.indicativo_color || msg.color || '#3498db'
        };
        div.style.cursor = 'pointer';
        div.addEventListener('click', function() {
            const marker = markerRefs[msg.indicativo_id];
            if (marker) {
                map.setView([msg.content.lat, msg.content.lng], 15);
                marker.openPopup();
                if (selectedMarker) selectedMarker.setZIndexOffset(0);
                marker.setZIndexOffset(1000);
                selectedMarker = marker;
            }
        });
    } else if (msg.content.type === 'assign_service') {
        const gmaps = `https://maps.google.com/?q=${msg.content.lat},${msg.content.lng}`;
        div.innerHTML += `<div class=\"content assign-service-msg\" style=\"background:#ffeaea;border-left:5px solid #e74c3c;padding:7px 10px;border-radius:4px;\">üèçÔ∏è <b>Servicio asignado:</b> ${msg.content.text}<br>üìç <a href='${gmaps}' target='_blank' style='color:#c0392b;text-decoration:underline;font-weight:bold;'>Ver ubicaci√≥n en Google Maps</a></div>`;
    } else {
        div.innerHTML += `<div class=\"content\">[${msg.content.type}]</div>`;
    }
    chatHistory.appendChild(div);
    chatHistory.scrollTop = chatHistory.scrollHeight;
    if (msg.content.type === 'location') {
        updateLocationMarkers(autoCenter);
    } else {
        updateLocationMarkers(false);
    }
}

function joinChat() {
    if (!indicativoId) return;
    if (socket) socket.disconnect();
    socket = io();
    socket.emit('join_event', { event_id: eventId, indicativo_id: indicativoId });
    joined = true;
    socket.on('message_history', data => {
        chatHistory.innerHTML = '';
        Object.keys(lastLocations).forEach(k => delete lastLocations[k]);
        Object.keys(markerRefs).forEach(k => { map.removeLayer(markerRefs[k]); delete markerRefs[k]; });
        (data.messages || []).forEach(msg => {
            appendMessage(msg);
        });
        chatHistory.scrollTop = chatHistory.scrollHeight;
        programmaticMoves++;
        updateLocationMarkers(true);
    });
    socket.on('new_message', msg => {
        appendMessage(msg);
        locationModal.style.display = 'none';
    });
    socket.on('error', err => {
        alert(err.message);
    });
}
indicativoSelect.addEventListener('change', function() {
    if (this.value) joinChat();
});
if (indicativoId) joinChat();
document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!indicativoId) return alert('Selecciona un indicativo');
    const text = document.getElementById('chatInput').value.trim();
    const toIndicativoId = document.getElementById('toIndicativoSelect').value || null;
    if (!text) return;
    socket.emit('send_message', {
        event_id: eventId,
        indicativo_id: indicativoId,
        to_indicativo_id: toIndicativoId,
        content: { type: 'text', text }
    });
    document.getElementById('chatInput').value = '';
});
// --- MODAL UBICACI√ìN MANUAL ---
const locationModal = document.getElementById('locationModal');
const closeLocationModal = document.getElementById('closeLocationModal');
const addressInput = document.getElementById('addressInput');
const searchAddressBtn = document.getElementById('searchAddressBtn');
const latInput = document.getElementById('latInput');
const lngInput = document.getElementById('lngInput');
const sendManualLocationBtn = document.getElementById('sendManualLocationBtn');
let manualMap = null, manualMarker;
let manualMapMarkers = {}; // Para los marcadores de otros indicativos en el modal

function openLocationModal() {
    locationModal.style.display = 'flex';
    // Centrar en Barcelona
    if (!manualMap) {
        manualMap = L.map('manualMap').setView([41.3874, 2.1686], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(manualMap);
        manualMap.on('click', function(e) {
            setManualMarker(e.latlng.lat, e.latlng.lng);
        });
    } else {
        manualMap.setView([41.3874, 2.1686], 13);
    }
    // Limpiar marcador manual
    if (manualMarker) manualMap.removeLayer(manualMarker);
    latInput.value = '';
    lngInput.value = '';
    addressInput.value = '';
    // Limpiar marcadores de otros indicativos
    Object.values(manualMapMarkers).forEach(m => manualMap.removeLayer(m));
    manualMapMarkers = {};
    // A√±adir marcadores de las √∫ltimas ubicaciones de cada indicativo
    Object.values(lastLocations).forEach(msg => {
        if (msg.content.type === 'location') {
            const color = msg.indicativo_color || '#3498db';
            const marker = L.marker([msg.content.lat, msg.content.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style=\"background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff;\"></div>`
                })
            }).addTo(manualMap);
            marker.bindPopup(`<b>${msg.indicativo}</b><br>${msg.timestamp}`);
            manualMapMarkers[msg.indicativo_id] = marker;
        }
    });
}
function closeLocationModalFn() {
    locationModal.style.display = 'none';
}
function setManualMarker(lat, lng) {
    if (manualMarker) manualMap.removeLayer(manualMarker);
    manualMarker = L.marker([lat, lng]).addTo(manualMap);
    latInput.value = lat;
    lngInput.value = lng;
}
searchAddressBtn.addEventListener('click', function() {
    const address = addressInput.value.trim();
    if (!address) return;
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(r => r.json())
        .then(results => {
            if (results && results.length > 0) {
                const { lat, lon } = results[0];
                setManualMarker(parseFloat(lat), parseFloat(lon));
                manualMap.setView([lat, lon], 16);
            } else {
                alert('Direcci√≥n no encontrada');
            }
        });
});
latInput.addEventListener('change', function() {
    const lat = parseFloat(latInput.value);
    const lng = parseFloat(lngInput.value);
    if (!isNaN(lat) && !isNaN(lng)) setManualMarker(lat, lng);
});
lngInput.addEventListener('change', function() {
    const lat = parseFloat(latInput.value);
    const lng = parseFloat(lngInput.value);
    if (!isNaN(lat) && !isNaN(lng)) setManualMarker(lat, lng);
});
closeLocationModal.addEventListener('click', closeLocationModalFn);
sendManualLocationBtn.addEventListener('click', function() {
    const lat = parseFloat(latInput.value);
    const lng = parseFloat(lngInput.value);
    if (isNaN(lat) || isNaN(lng)) return alert('Introduce una latitud y longitud v√°lidas');
    if (!indicativoId) return alert('Selecciona un indicativo');
    socket.emit('send_message', {
        event_id: eventId,
        indicativo_id: indicativoId,
        content: { type: 'location', lat, lng }
    });
    closeLocationModalFn();
});
document.getElementById('sendLocationBtn').addEventListener('click', function() {
    if (!indicativoId) return alert('Selecciona un indicativo');
    // Solo m√≥vil: usar geolocalizaci√≥n
    if (/Mobi|Android/i.test(navigator.userAgent)) {
        if (!navigator.geolocation) return alert('Geolocalizaci√≥n no soportada');
        navigator.geolocation.getCurrentPosition(function(pos) {
            const { latitude, longitude } = pos.coords;
            socket.emit('send_message', {
                event_id: eventId,
                indicativo_id: indicativoId,
                content: { type: 'location', lat: latitude, lng: longitude }
            });
        }, function() {
            alert('No se pudo obtener la ubicaci√≥n');
        });
    } else {
        openLocationModal();
    }
});
document.getElementById('fitMarkersBtn').addEventListener('click', function() {
    const markerList = Object.values(markerRefs);
    if (markerList.length === 0) return;
    if (markerList.length === 1) {
        map.setView(markerList[0].getLatLng(), 15);
    } else {
        const group = L.featureGroup(markerList);
        map.fitBounds(group.getBounds().pad(0.2));
    }
});
addressInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchAddressBtn.click();
    }
});

// JS para el modal de asignar servicio
let assignServiceMap = null, assignServiceMarker;
let assignServiceMapMarkers = {};
const assignServiceModal = document.getElementById('assignServiceModal');
const closeAssignServiceModal = document.getElementById('closeAssignServiceModal');
const assignToIndicativoSelect = document.getElementById('assignToIndicativoSelect');
const assignServiceText = document.getElementById('assignServiceText');
const assignLatInput = document.getElementById('assignLatInput');
const assignLngInput = document.getElementById('assignLngInput');
const sendAssignServiceBtn = document.getElementById('sendAssignServiceBtn');

document.getElementById('assignServiceBtn').addEventListener('click', function() {
    openAssignServiceModal();
});
closeAssignServiceModal.addEventListener('click', closeAssignServiceModalFn);

function openAssignServiceModal() {
    assignServiceModal.style.display = 'flex';
    assignToIndicativoSelect.value = '';
    assignServiceText.value = '';
    assignLatInput.value = '';
    assignLngInput.value = '';
    // Mapa
    if (!assignServiceMap) {
        assignServiceMap = L.map('assignServiceMap').setView([41.3874, 2.1686], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(assignServiceMap);
        assignServiceMap.on('click', function(e) {
            setAssignServiceMarker(e.latlng.lat, e.latlng.lng);
        });
    } else {
        assignServiceMap.setView([41.3874, 2.1686], 13);
    }
    // Limpiar marcador manual
    if (assignServiceMarker) assignServiceMap.removeLayer(assignServiceMarker);
    // Limpiar marcadores de otros indicativos
    Object.values(assignServiceMapMarkers).forEach(m => assignServiceMap.removeLayer(m));
    assignServiceMapMarkers = {};
    // A√±adir marcadores de las √∫ltimas ubicaciones de cada indicativo
    Object.values(lastLocations).forEach(msg => {
        if (msg.content.type === 'location') {
            const color = msg.indicativo_color || '#3498db';
            const marker = L.marker([msg.content.lat, msg.content.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style=\"background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff;\"></div>`
                })
            }).addTo(assignServiceMap);
            marker.bindPopup(`<b>${msg.indicativo}</b><br>${msg.timestamp}`);
            assignServiceMapMarkers[msg.indicativo_id] = marker;
        }
    });
}
function closeAssignServiceModalFn() {
    assignServiceModal.style.display = 'none';
}
function setAssignServiceMarker(lat, lng) {
    if (assignServiceMarker) assignServiceMap.removeLayer(assignServiceMarker);
    assignServiceMarker = L.marker([lat, lng]).addTo(assignServiceMap);
    assignLatInput.value = lat;
    assignLngInput.value = lng;
}
assignLatInput.addEventListener('change', function() {
    const lat = parseFloat(assignLatInput.value);
    const lng = parseFloat(assignLngInput.value);
    if (!isNaN(lat) && !isNaN(lng)) setAssignServiceMarker(lat, lng);
});
assignLngInput.addEventListener('change', function() {
    const lat = parseFloat(assignLatInput.value);
    const lng = parseFloat(assignLngInput.value);
    if (!isNaN(lat) && !isNaN(lng)) setAssignServiceMarker(lat, lng);
});
sendAssignServiceBtn.addEventListener('click', function() {
    const toIndicativoId = assignToIndicativoSelect.value;
    const text = assignServiceText.value.trim();
    const lat = parseFloat(assignLatInput.value);
    const lng = parseFloat(assignLngInput.value);
    if (!toIndicativoId) return alert('Selecciona un indicativo destinatario');
    if (!text) return alert('Introduce una descripci√≥n del servicio');
    if (isNaN(lat) || isNaN(lng)) return alert('Selecciona una ubicaci√≥n en el mapa');
    if (!indicativoId) return alert('Selecciona tu indicativo');
    socket.emit('send_message', {
        event_id: eventId,
        indicativo_id: indicativoId,
        to_indicativo_id: toIndicativoId,
        content: { type: 'assign_service', lat, lng, text }
    });
    closeAssignServiceModalFn();
});

// JS para el modal de incidentes
const incidentModal = document.getElementById('incidentModal');
const closeIncidentModal = document.getElementById('closeIncidentModal');
const addIncidentBtn = document.getElementById('addIncidentBtn');
const incidentForm = document.getElementById('incidentForm');
const incidentModalTitle = document.getElementById('incidentModalTitle');
const incidentTipoInput = document.getElementById('incidentTipo');
const dorsalGroup = document.getElementById('dorsalGroup');
const patologiaGroup = document.getElementById('patologiaGroup');
const incidentAddressSearchInput = document.getElementById('incidentAddressSearchInput');
const incidentSearchAddressBtn = document.getElementById('incidentSearchAddressBtn');

// Campo oculto o variable para guardar el ID del incidente que se est√° editando
let editingIncidentId = null;

// Mapa para el modal de incidentes
let incidentMap = null, incidentMarker = null;

addIncidentBtn.addEventListener('click', function() {
    incidentModalTitle.textContent = 'Nuevo Incidente';
    incidentForm.reset(); // Limpia el formulario
    // Aseg√∫rate de que los campos opcionales est√©n ocultos al abrir para nuevo incidente
    dorsalGroup.style.display = 'none';
    patologiaGroup.style.display = 'none';
    document.getElementById('tipoOtroGroup').style.display = 'none';
    document.getElementById('reportadoOtroGroup').style.display = 'none';
    document.getElementById('incidentTipoOtro').required = false;
    document.getElementById('incidentReportadoOtro').required = false;
    // Limpiar expl√≠citamente los campos de texto libre
    document.getElementById('incidentTipoOtro').value = '';
    document.getElementById('incidentReportadoOtro').value = '';
    editingIncidentId = null; // Asegurarse de que no estamos en modo edici√≥n
    document.getElementById('incidentLat').value = ''; // Limpiar campos de lat/lng
    document.getElementById('incidentLng').value = '';

    incidentModal.style.display = 'flex';
    
    // Inicializar o re-centrar mapa del modal de incidentes
    if (!incidentMap) {
        incidentMap = L.map('incidentMap').setView([41.3874, 2.1686], 13); // Coordenadas de ejemplo
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(incidentMap);
        incidentMap.on('click', function(e) {
            setIncidentMarker(e.latlng.lat, e.latlng.lng);
        });
    } else {
        incidentMap.setView([41.3874, 2.1686], 13); // Re-centrar
        if (incidentMarker) {
            incidentMap.removeLayer(incidentMarker);
            incidentMarker = null;
        }
    }
    // Invalidar el tama√±o del mapa para asegurar que se renderiza correctamente dentro del modal
    setTimeout(() => {
        if (incidentMap) incidentMap.invalidateSize();
    }, 10);
});

closeIncidentModal.addEventListener('click', function() {
    incidentModal.style.display = 'none';
    // Limpiar campos de texto libre
    document.getElementById('tipoOtroGroup').style.display = 'none';
    document.getElementById('reportadoOtroGroup').style.display = 'none';
    document.getElementById('incidentTipoOtro').value = '';
    document.getElementById('incidentReportadoOtro').value = '';
    document.getElementById('incidentTipoOtro').required = false;
    document.getElementById('incidentReportadoOtro').required = false;
    editingIncidentId = null;
    if (incidentMarker) {
        incidentMap.removeLayer(incidentMarker);
        incidentMarker = null;
    }
});

incidentTipoInput.addEventListener('change', function() {
    const tipoOtroGroup = document.getElementById('tipoOtroGroup');
    
    if (this.value === 'üöë Asistencia M√©dica') {
        dorsalGroup.style.display = 'block';
        patologiaGroup.style.display = 'block';
    } else {
        dorsalGroup.style.display = 'none';
        patologiaGroup.style.display = 'none';
    }
    
    if (this.value === 'Otro') {
        tipoOtroGroup.style.display = 'block';
        document.getElementById('incidentTipoOtro').required = true;
    } else {
        tipoOtroGroup.style.display = 'none';
        document.getElementById('incidentTipoOtro').required = false;
    }
});

// Event listener para "Reportado por"
document.getElementById('incidentReportadoPor').addEventListener('change', function() {
    const reportadoOtroGroup = document.getElementById('reportadoOtroGroup');
    
    if (this.value === 'Otro') {
        reportadoOtroGroup.style.display = 'block';
        document.getElementById('incidentReportadoOtro').required = true;
    } else {
        reportadoOtroGroup.style.display = 'none';
        document.getElementById('incidentReportadoOtro').required = false;
    }
});

async function setIncidentMarker(lat, lng) {
    if (incidentMarker) incidentMap.removeLayer(incidentMarker);
    incidentMarker = L.marker([lat, lng]).addTo(incidentMap);
    document.getElementById('incidentLat').value = lat;
    document.getElementById('incidentLng').value = lng;
    
    // Actualizar la direcci√≥n autom√°ticamente
    const addressDisplay = document.getElementById('incidentAddressDisplay');
    addressDisplay.textContent = 'Obteniendo direcci√≥n...';
    addressDisplay.style.color = '#666';
    
    try {
        let searchQuery = `${lat},${lng}`;
        const reverseUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
        const response = await fetch(reverseUrl);
        
        if (response.ok) {
            const data = await response.json();
            const address = data.address;
            let displayAddress = '';
            
            if (address) {
                const road = address.road || '';
                const house_number = address.house_number || '';
                const city = address.city || address.town || address.village || '';
                
                displayAddress = road;
                if (house_number) {
                    displayAddress += `, ${house_number}`;
                }
                if (city) {
                    displayAddress += ` - ${city}`;
                }
                
                if (!displayAddress) {
                    displayAddress = data.display_name || 'Ubicaci√≥n seleccionada';
                }
            } else {
                displayAddress = data.display_name || 'Ubicaci√≥n seleccionada';
            }
            
            addressDisplay.textContent = displayAddress;
            addressDisplay.style.color = '#333';
        } else {
            addressDisplay.textContent = 'Ubicaci√≥n seleccionada (direcci√≥n no disponible)';
            addressDisplay.style.color = '#999';
        }
    } catch (error) {
        console.error('Error al obtener direcci√≥n:', error);
        addressDisplay.textContent = 'Ubicaci√≥n seleccionada';
        addressDisplay.style.color = '#333';
    }
}

// Funci√≥n para poblar y abrir el modal de incidentes para edici√≥n
async function openIncidentModalForEdit(incidentId) {
    try {
        // Limpiar campos de texto libre antes de cargar datos
        document.getElementById('tipoOtroGroup').style.display = 'none';
        document.getElementById('reportadoOtroGroup').style.display = 'none';
        document.getElementById('incidentTipoOtro').value = '';
        document.getElementById('incidentReportadoOtro').value = '';
        document.getElementById('incidentTipoOtro').required = false;
        document.getElementById('incidentReportadoOtro').required = false;
        
        const response = await fetch(`/events/${eventId}/incidents/${incidentId}`);
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        const result = await response.json();

        if (result.status === 'success' && result.incident) {
            const incident = result.incident;
            incidentModalTitle.textContent = `Editando Incidente #${incident.incident_number}`;
            
            // Manejar tipo de incidente
            const tipoSelect = document.getElementById('incidentTipo');
            const tipoOtroGroup = document.getElementById('tipoOtroGroup');
            const tipoOtroInput = document.getElementById('incidentTipoOtro');
            
            // Verificar si el tipo est√° en las opciones predefinidas
            let tipoEncontrado = false;
            for (let option of tipoSelect.options) {
                if (option.value === incident.tipo) {
                    tipoSelect.value = incident.tipo;
                    tipoEncontrado = true;
                    break;
                }
            }
            
            if (!tipoEncontrado && incident.tipo) {
                // Es un tipo personalizado
                tipoSelect.value = 'Otro';
                tipoOtroGroup.style.display = 'block';
                tipoOtroInput.value = incident.tipo;
                tipoOtroInput.required = true;
            } else {
                tipoOtroGroup.style.display = 'none';
                tipoOtroInput.required = false;
            }
            
            // Manejar reportado por
            const reportadoSelect = document.getElementById('incidentReportadoPor');
            const reportadoOtroGroup = document.getElementById('reportadoOtroGroup');
            const reportadoOtroInput = document.getElementById('incidentReportadoOtro');
            
            // Verificar si el reportado por est√° en las opciones predefinidas
            let reportadoEncontrado = false;
            for (let option of reportadoSelect.options) {
                if (option.value === incident.reportado_por) {
                    reportadoSelect.value = incident.reportado_por;
                    reportadoEncontrado = true;
                    break;
                }
            }
            
            if (!reportadoEncontrado && incident.reportado_por) {
                // Es un reportado por personalizado
                reportadoSelect.value = 'Otro';
                reportadoOtroGroup.style.display = 'block';
                reportadoOtroInput.value = incident.reportado_por;
                reportadoOtroInput.required = true;
            } else {
                reportadoOtroGroup.style.display = 'none';
                reportadoOtroInput.required = false;
            }
            
            document.getElementById('incidentDescripcion').value = incident.descripcion || '';
            document.getElementById('incidentInfoUbicacion').value = incident.info_ubicacion || '';
            // Usar la nueva funci√≥n para establecer el estado con botones visuales
            setIncidentStatus(incident.estado || 'activo');
            document.getElementById('incidentDorsal').value = incident.dorsal || '';
            document.getElementById('incidentPatologia').value = incident.patologia || '';
            
            // Mostrar campos de dorsal/patolog√≠a si es asistencia m√©dica
            if (incident.tipo === 'üöë Asistencia M√©dica') {
                dorsalGroup.style.display = 'block';
                patologiaGroup.style.display = 'block';
            } else {
                dorsalGroup.style.display = 'none';
                patologiaGroup.style.display = 'none';
            }

            editingIncidentId = incident.id; // Guardar el ID del incidente que se est√° editando

            // Mapa
            document.getElementById('incidentLat').value = incident.lat || '';
            document.getElementById('incidentLng').value = incident.lng || '';
            // Mostrar direcci√≥n formateada si est√° disponible
            document.getElementById('incidentAddressDisplay').textContent = incident.direccion_formateada || '';

            if (incidentMap) {
                 if (incidentMarker) incidentMap.removeLayer(incidentMarker);
                 incidentMarker = null; // Reset marker
                if (incident.lat && incident.lng) {
                    const latLng = [incident.lat, incident.lng];
                    incidentMap.setView(latLng, 15);
                    setIncidentMarker(incident.lat, incident.lng);
                } else {
                    incidentMap.setView([41.3874, 2.1686], 13); // Vista por defecto si no hay coords
                }
            } else {
                // Si el mapa no est√° inicializado (raro aqu√≠, pero por si acaso)
                 incidentMap = L.map('incidentMap').setView( (incident.lat && incident.lng) ? [incident.lat, incident.lng] : [41.3874, 2.1686], 13);
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(incidentMap);
                 incidentMap.on('click', function(e) { setIncidentMarker(e.latlng.lat, e.latlng.lng); });
                 if (incident.lat && incident.lng) setIncidentMarker(incident.lat, incident.lng);
            }
             setTimeout(() => { if (incidentMap) incidentMap.invalidateSize();}, 10);


            incidentModal.style.display = 'flex';
        } else {
            alert(`Error al cargar datos del incidente: ${result.message || 'Incidente no encontrado.'}`);
        }
    } catch (error) {
        console.error('Error al obtener datos del incidente para editar:', error);
        alert('Error de red al intentar cargar datos del incidente.');
    }
}



// Variables globales para filtrado y ordenaci√≥n
let allIncidents = []; // Almacenar todos los incidentes
let filteredIncidents = []; // Incidentes despu√©s de aplicar filtros

function renderIncidents(incidents) {
    const tableBody = document.getElementById('incidentsTableBody');
    tableBody.innerHTML = ''; // Limpiar tabla

    // Actualizar contador
    updateIncidentCount(incidents.length);

    if (!incidents || incidents.length === 0) {
        const row = tableBody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 8; // N√∫mero de columnas de la tabla
        cell.textContent = filteredIncidents.length === 0 && allIncidents.length > 0 ? 
            'No se encontraron incidentes que coincidan con los filtros.' : 
            'No hay incidentes registrados para este evento.';
        cell.style.textAlign = 'center';
        cell.style.color = '#666';
        cell.style.fontStyle = 'italic';
        return;
    }

    incidents.forEach(incident => {
        const row = tableBody.insertRow();
        if (incident.is_deleted) {
            row.classList.add('deleted-incident');
        }

        row.insertCell().textContent = incident.incident_number;
        
        // Celda de tipo con dorsal si es m√©dico
        const tipoCell = row.insertCell();
        let tipoText = incident.tipo;
        if (incident.tipo === 'üöë Asistencia M√©dica' && incident.dorsal) {
            tipoText += ` (Dorsal: ${incident.dorsal})`;
        }
        tipoCell.textContent = tipoText;
        
        // Celda de estado con colores y clickable
        const statusCell = row.insertCell();
        const statusSpan = document.createElement('span');
        statusSpan.className = `incident-status status-${incident.estado}`;
        statusSpan.innerHTML = `<span class="status-dot"></span>${incident.estado}`;
        statusSpan.style.cursor = 'pointer';
        statusSpan.title = 'Clic para cambiar estado';
        statusSpan.addEventListener('click', function() {
            openStatusChangeModal(incident.id, incident.incident_number, incident.estado);
        });
        statusCell.appendChild(statusSpan);
        row.insertCell().textContent = incident.descripcion ? incident.descripcion.substring(0, 50) + (incident.descripcion.length > 50 ? '...' : '') : '-';
        row.insertCell().textContent = incident.reportado_por || '-';
        
        const locCell = row.insertCell();
        locCell.style.minWidth = '200px'; // Para dar espacio a la direcci√≥n
        if (incident.lat && incident.lng) {
            const gmapsLink = `<a href="https://maps.google.com/?q=${incident.lat},${incident.lng}" target="_blank" title="Ver en mapa" style="color:#007bff; text-decoration:none;">üìç</a>`;
            const address = incident.direccion_formateada || 'Direcci√≥n no disponible';
            let locationInfo = `${gmapsLink} <span style="margin-left:5px;">${address}</span>`;
            
            // A√±adir informaci√≥n adicional de ubicaci√≥n si existe
            if (incident.info_ubicacion && incident.info_ubicacion.trim()) {
                locationInfo += `<br><small style="color:#666; margin-left:20px;">üìå ${incident.info_ubicacion}</small>`;
            }
            
            locCell.innerHTML = locationInfo;
        } else {
            locCell.textContent = '-';
        }

        const assignmentsCell = row.insertCell();
        assignmentsCell.style.minWidth = '200px'; // Para dar espacio a los estados
        if (incident.assignments && incident.assignments.length > 0) {
            // Filtrar solo asignaciones activas (no finalizadas)
            const activeAssignments = incident.assignments.filter(assignment => 
                assignment.estado_asignacion !== 'finalizado'
            );
            
            if (activeAssignments.length > 0) {
                let html = '';
                activeAssignments.forEach((assignment, index) => {
                    const statusEmoji = getStatusEmoji(assignment.estado_asignacion);
                    const statusText = getStatusText(assignment.estado_asignacion);
                    const statusColors = getStatusColors(assignment.estado_asignacion);
                    
                    if (index > 0) assignmentsHtml += '<br>';
                    assignmentsHtml += `
                        <div class="assignment-status-badge" 
                             data-assignment-id="${assignment.id}" 
                             data-assignment-name="${assignment.indicativo_nombre}" 
                             data-assignment-status="${assignment.estado_asignacion}" 
                             data-incident-id="${incident.id}"
                             data-incident-number="${incident.incident_number}"
                             data-incident-type="${incident.tipo}"
                             data-incident-dorsal="${incident.dorsal || ''}"
                             style="display:inline-flex; align-items:center; margin:2px 0; padding:3px 6px; border-radius:12px; font-size:11px; background:${statusColors.bg}; color:${statusColors.text}; border:1px solid ${statusColors.border}; cursor:pointer; transition: all 0.2s ease;" 
                             title="Clic para cambiar estado de asignaci√≥n"
                             onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'"
                             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                            <span style="margin-right:4px;">${statusEmoji}</span>
                            <strong style="margin-right:4px;">${assignment.indicativo_nombre}</strong>
                            <span>${statusText}</span>
                        </div>
                    `;
                });
                assignmentsCell.innerHTML = assignmentsHtml;
            } else {
                assignmentsCell.innerHTML = '<em style="color:#999;">Sin Ind. Activos</em>';
            }
        } else {
            assignmentsCell.innerHTML = '<em style="color:#999;">Sin Ind. Activos</em>';
        }

        const actionsCell = row.insertCell();
        if (incident.is_deleted) {
            actionsCell.innerHTML = `<button class="restore-incident-btn" data-id="${incident.id}" title="Restaurar incidente">‚ôªÔ∏è</button>`;
        } else {
            actionsCell.innerHTML = `<button class="edit-incident-btn" data-id="${incident.id}" title="Editar incidente">‚úèÔ∏è</button> <button class="assign-incident-btn" data-id="${incident.id}" title="Asignar incidente">üë•</button> <button class="delete-incident-btn" data-id="${incident.id}" title="Eliminar incidente">üóëÔ∏è</button>`;
        }
    });
    
    // Agregar event listeners para los badges de asignaci√≥n
    document.querySelectorAll('.assignment-status-badge').forEach(badge => {
        badge.addEventListener('click', function() {
            const assignmentId = this.dataset.assignmentId;
            const assignmentName = this.dataset.assignmentName;
            const assignmentStatus = this.dataset.assignmentStatus;
            const incidentId = this.dataset.incidentId;
            const incidentNumber = this.dataset.incidentNumber;
            const incidentType = this.dataset.incidentType;
            const incidentDorsal = this.dataset.incidentDorsal;
            openQuickAssignmentStatusModal(assignmentId, assignmentName, assignmentStatus, incidentId, incidentNumber, incidentType, incidentDorsal);
        });
    });
}

function updateIncidentCount(count) {
    const countElement = document.getElementById('incidentCount');
    if (countElement) {
        countElement.textContent = `${count} incidente${count !== 1 ? 's' : ''}`;
    }
}

function filterAndSortIncidents() {
    const searchTerm = document.getElementById('incidentSearch').value.toLowerCase().trim();
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const sortField = document.getElementById('sortField').value;
    const sortOrder = document.getElementById('sortOrder').value;

    // Aplicar filtros
    filteredIncidents = allIncidents.filter(incident => {
        // Filtro de b√∫squeda general
        if (searchTerm) {
            const searchableText = [
                incident.incident_number?.toString(),
                incident.tipo,
                incident.descripcion,
                incident.reportado_por,
                incident.direccion_formateada,
                incident.info_ubicacion,
                incident.dorsal,
                incident.patologia
            ].filter(Boolean).join(' ').toLowerCase();
            
            if (!searchableText.includes(searchTerm)) {
                return false;
            }
        }

        // Filtro por estado
        if (statusFilter && incident.estado !== statusFilter) {
            return false;
        }

        // Filtro por tipo
        if (typeFilter && incident.tipo !== typeFilter) {
            return false;
        }

        return true;
    });

    // Aplicar ordenaci√≥n
    filteredIncidents.sort((a, b) => {
        let valueA = a[sortField];
        let valueB = b[sortField];

        // Manejar valores nulos/undefined
        if (valueA == null) valueA = '';
        if (valueB == null) valueB = '';

        // Convertir a string para comparaci√≥n
        valueA = valueA.toString().toLowerCase();
        valueB = valueB.toString().toLowerCase();

        // Para n√∫meros (como incident_number)
        if (sortField === 'incident_number') {
            valueA = parseInt(a[sortField]) || 0;
            valueB = parseInt(b[sortField]) || 0;
        }

        let comparison = 0;
        if (valueA < valueB) {
            comparison = -1;
        } else if (valueA > valueB) {
            comparison = 1;
        }

        return sortOrder === 'desc' ? comparison * -1 : comparison;
    });

    // Renderizar resultados filtrados y ordenados
    renderIncidents(filteredIncidents);
}

async function loadIncidents() {
    const showDeleted = document.getElementById('showDeletedIncidents').checked;
    let apiUrl = `/events/${eventId}/incidents`;
    if (showDeleted) {
        apiUrl += '?include_deleted=true';
    }

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        const result = await response.json();
        if (result.status === 'success') {
            allIncidents = result.incidents || [];
            filterAndSortIncidents(); // Aplicar filtros y ordenaci√≥n
        } else {
            console.error('Error al cargar incidentes:', result.message);
            allIncidents = [];
            renderIncidents([]); // Mostrar tabla vac√≠a o con mensaje de error
        }
    } catch (error) {
        console.error('Error de red al cargar incidentes:', error);
        allIncidents = [];
        renderIncidents([]); // Mostrar tabla vac√≠a o con mensaje de error
        const tableBody = document.getElementById('incidentsTableBody');
        if (tableBody.innerHTML === '') { // Si renderIncidents([]) no puso nada por error previo
            const row = tableBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 8;
            cell.textContent = 'Error al cargar incidentes.';
            cell.style.textAlign = 'center';
        }
    }
}

// Event listener para el checkbox "Mostrar eliminados"
document.getElementById('showDeletedIncidents').addEventListener('change', loadIncidents);

// Variables para el modal de cambio de estado
const statusChangeModal = document.getElementById('statusChangeModal');
const closeStatusModal = document.getElementById('closeStatusModal');
const statusModalTitle = document.getElementById('statusModalTitle');
const statusModalIncidentInfo = document.getElementById('statusModalIncidentInfo');
let currentIncidentForStatusChange = null;

// Variables para el modal de asignaci√≥n de incidentes
const assignIncidentModal = document.getElementById('assignIncidentModal');
const closeAssignIncidentModal = document.getElementById('closeAssignIncidentModal');
const assignIncidentModalTitle = document.getElementById('assignIncidentModalTitle');
const assignIncidentInfo = document.getElementById('assignIncidentInfo');
const assignIncidentForm = document.getElementById('assignIncidentForm');
const cancelAssignBtn = document.getElementById('cancelAssignBtn');
let currentIncidentForAssignment = null;

// Variables para el modal de cambio de estado de asignaci√≥n
const assignmentStatusModal = document.getElementById('assignmentStatusModal');
const closeAssignmentStatusModal = document.getElementById('closeAssignmentStatusModal');
const assignmentStatusModalTitle = document.getElementById('assignmentStatusModalTitle');
const assignmentStatusModalInfo = document.getElementById('assignmentStatusModalInfo');
let currentAssignmentForStatusChange = null;

// Funci√≥n para abrir el modal de cambio de estado
async function openStatusChangeModal(incidentId, incidentNumber, currentStatus) {
    currentIncidentForStatusChange = incidentId;
    
    try {
        // Obtener datos del incidente para mostrar informaci√≥n completa
        const response = await fetch(`/events/${eventId}/incidents/${incidentId}`);
        if (response.ok) {
            const result = await response.json();
            if (result.status === 'success' && result.incident) {
                const incident = result.incident;
                
                // Construir informaci√≥n del incidente
                let incidentInfo = `Incidente #${incident.incident_number} - ${incident.tipo}`;
                
                // A√±adir dorsal si es asistencia m√©dica y tiene dorsal
                if (incident.tipo === 'üöë Asistencia M√©dica' && incident.dorsal && incident.dorsal.trim() !== '') {
                    incidentInfo += ` (Dorsal: ${incident.dorsal})`;
                }
                
                statusModalIncidentInfo.textContent = incidentInfo;
            } else {
                // Fallback si no se puede obtener la informaci√≥n completa
                statusModalIncidentInfo.textContent = `Incidente #${incidentNumber}`;
            }
        } else {
            // Fallback si hay error en la petici√≥n
            statusModalIncidentInfo.textContent = `Incidente #${incidentNumber}`;
        }
    } catch (error) {
        console.error('Error al obtener informaci√≥n del incidente:', error);
        // Fallback si hay error de red
        statusModalIncidentInfo.textContent = `Incidente #${incidentNumber}`;
    }
    
    // Resaltar el estado actual en los botones
    document.querySelectorAll('.status-change-btn').forEach(btn => {
        const btnStatus = btn.dataset.status;
        if (btnStatus === currentStatus) {
            btn.classList.add('current-status');
        } else {
            btn.classList.remove('current-status');
        }
    });
    
    statusChangeModal.style.display = 'flex';
}

// Funci√≥n para abrir el modal de asignaci√≥n de incidentes
async function openAssignIncidentModal(incidentId) {
    currentIncidentForAssignment = incidentId;
    
    try {
        // Obtener datos del incidente
        const response = await fetch(`/events/${eventId}/incidents/${incidentId}`);
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        const result = await response.json();
        
        if (result.status === 'success' && result.incident) {
            const incident = result.incident;
            assignIncidentModalTitle.textContent = `Asignar Incidente #${incident.incident_number}`;
            assignIncidentInfo.textContent = `${incident.tipo} - ${incident.descripcion || 'Sin descripci√≥n'}`;
            
            // Cargar asignaciones actuales
            await loadCurrentAssignments(incidentId);
            
            // Limpiar formulario
            assignIncidentForm.reset();
            document.getElementById('assignIndicativoSelect').value = '';
            document.getElementById('assignOtro').value = '';
            document.getElementById('assignOtroGroup').style.display = 'none';
            document.getElementById('assignOtro').required = false;
            setAssignmentStatus('avisado');
            
            assignIncidentModal.style.display = 'flex';
        } else {
            alert(`Error al cargar datos del incidente: ${result.message || 'Incidente no encontrado.'}`);
        }
    } catch (error) {
        console.error('Error al obtener datos del incidente para asignar:', error);
        alert('Error de red al intentar cargar datos del incidente.');
    }
}

// Funci√≥n para cargar asignaciones actuales
async function loadCurrentAssignments(incidentId) {
    const currentAssignmentsDiv = document.getElementById('currentAssignments');
    currentAssignmentsDiv.innerHTML = '<em style="color:#666;">Cargando asignaciones...</em>';
    
    try {
        const response = await fetch(`/events/${eventId}/incidents/${incidentId}/assignments`);
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        const result = await response.json();
        
        if (result.status === 'success') {
            const assignments = result.assignments || [];
            
            if (assignments.length === 0) {
                currentAssignmentsDiv.innerHTML = '<em style="color:#666;">No hay asignaciones actuales</em>';
                // Ocultar controles de batch si no hay asignaciones
                document.getElementById('batchControls').style.display = 'none';
                document.getElementById('batchStatusControls').style.display = 'none';
            } else {
                let html = '';
                assignments.forEach(assignment => {
                    const statusColors = getStatusColors(assignment.estado_asignacion);
                    const statusEmoji = getStatusEmoji(assignment.estado_asignacion);
                    const statusText = getStatusText(assignment.estado_asignacion);
                    
                    html += `
                        <div class="assignment-row" data-assignment-id="${assignment.id}" style="display:flex; justify-content:space-between; align-items:center; padding:8px; border:1px solid #dee2e6; border-radius:4px; margin-bottom:8px; background:#fff; cursor:pointer; transition: all 0.2s ease;" 
                             onmouseover="this.style.backgroundColor='#f8f9fa'" 
                             onmouseout="this.style.backgroundColor='#fff'">
                            <div style="display:flex; align-items:center; flex:1;">
                                <input type="checkbox" class="assignment-checkbox" data-assignment-id="${assignment.id}" style="margin-right:12px;">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <strong style="min-width:120px;">${assignment.indicativo_nombre}</strong>
                                    <div class="status-badge" style="display:inline-flex; align-items:center; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:bold; background:${statusColors.bg}; color:${statusColors.text}; border:1px solid ${statusColors.border};">
                                        <span style="margin-right:4px;">${statusEmoji}</span>
                                        <span>${statusText}</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="remove-assignment-btn" data-assignment-id="${assignment.id}" style="background:#dc3545; color:#fff; border:none; padding:4px 8px; border-radius:3px; cursor:pointer;" title="Quitar asignaci√≥n" onclick="event.stopPropagation();">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                currentAssignmentsDiv.innerHTML = html;
                
                // Mostrar controles de batch si hay asignaciones
                document.getElementById('batchControls').style.display = 'block';
                
                // Agregar event listeners para checkboxes
                document.querySelectorAll('.assignment-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateBatchControls);
                });
                
                // Agregar event listeners para hacer clickeable toda la fila
                document.querySelectorAll('.assignment-row').forEach(row => {
                    row.addEventListener('click', function(e) {
                        // No hacer nada si se clickea el checkbox o el bot√≥n eliminar
                        if (e.target.classList.contains('assignment-checkbox') || 
                            e.target.classList.contains('remove-assignment-btn') ||
                            e.target.closest('.remove-assignment-btn')) {
                            return;
                        }
                        
                        // Toggle del checkbox
                        const checkbox = this.querySelector('.assignment-checkbox');
                        checkbox.checked = !checkbox.checked;
                        
                        // Trigger change event para actualizar controles
                        checkbox.dispatchEvent(new Event('change'));
                        
                        // Feedback visual
                        if (checkbox.checked) {
                            this.style.backgroundColor = '#e3f2fd';
                            this.style.borderColor = '#2196f3';
                        } else {
                            this.style.backgroundColor = '#fff';
                            this.style.borderColor = '#dee2e6';
                        }
                    });
                });
                
                updateBatchControls(); // Actualizar estado inicial
            }
        } else {
            currentAssignmentsDiv.innerHTML = '<em style="color:#e74c3c;">Error al cargar asignaciones</em>';
            document.getElementById('batchControls').style.display = 'none';
            document.getElementById('batchStatusControls').style.display = 'none';
        }
    } catch (error) {
        console.error('Error al cargar asignaciones:', error);
        currentAssignmentsDiv.innerHTML = '<em style="color:#e74c3c;">Error de red al cargar asignaciones</em>';
        document.getElementById('batchControls').style.display = 'none';
        document.getElementById('batchStatusControls').style.display = 'none';
    }
}

// Funci√≥n para actualizar controles de batch seg√∫n selecci√≥n
function updateBatchControls() {
    const checkboxes = document.querySelectorAll('.assignment-checkbox');
    const checkedBoxes = document.querySelectorAll('.assignment-checkbox:checked');
    const batchStatusControls = document.getElementById('batchStatusControls');
    
    if (checkedBoxes.length > 0) {
        batchStatusControls.style.display = 'block';
    } else {
        batchStatusControls.style.display = 'none';
    }
}

// Event listeners para controles de selecci√≥n
document.getElementById('selectAllBtn').addEventListener('click', function() {
    document.querySelectorAll('.assignment-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateBatchControls();
});

document.getElementById('deselectAllBtn').addEventListener('click', function() {
    document.querySelectorAll('.assignment-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateBatchControls();
});

// Event listeners para botones de cambio de estado en batch
document.querySelectorAll('.batch-status-btn').forEach(button => {
    button.addEventListener('click', async function() {
        const newStatus = this.dataset.status;
        const checkedBoxes = document.querySelectorAll('.assignment-checkbox:checked');
        
        if (checkedBoxes.length === 0) {
            alert('Por favor, selecciona al menos una asignaci√≥n para cambiar su estado.');
            return;
        }
        
        const assignmentIds = Array.from(checkedBoxes).map(cb => cb.dataset.assignmentId);
        const confirmMessage = `¬øEst√°s seguro de que quieres cambiar el estado de ${assignmentIds.length} asignaci√≥n${assignmentIds.length > 1 ? 'es' : ''} a "${getStatusText(newStatus)}"?`;
        
        if (!confirm(confirmMessage)) return;
        
        // Cambiar estado de todas las asignaciones seleccionadas
        let successCount = 0;
        let errorCount = 0;
        
        for (const assignmentId of assignmentIds) {
            try {
                const response = await fetch(`/events/${eventId}/incidents/${currentIncidentForAssignment}/assignments/${assignmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ estado_asignacion: newStatus }),
                });
                
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    successCount++;
                } else {
                    errorCount++;
                    console.error(`Error al cambiar estado de asignaci√≥n ${assignmentId}:`, result.message);
                }
            } catch (error) {
                errorCount++;
                console.error(`Error de red al cambiar estado de asignaci√≥n ${assignmentId}:`, error);
            }
        }
        
        // Mostrar resultado
        if (successCount > 0 && errorCount === 0) {
            alert(`‚úÖ Se cambiaron exitosamente ${successCount} asignaci√≥n${successCount > 1 ? 'es' : ''}.`);
        } else if (successCount > 0 && errorCount > 0) {
            alert(`‚ö†Ô∏è Se cambiaron ${successCount} asignaci√≥n${successCount > 1 ? 'es' : ''} exitosamente, pero ${errorCount} fallaron.`);
        } else {
            alert(`‚ùå Error: No se pudo cambiar ninguna asignaci√≥n.`);
        }
        
        // Recargar asignaciones y tabla de incidentes
        await loadCurrentAssignments(currentIncidentForAssignment);
        loadIncidents();
    });
});

// Funciones auxiliares para estados
function getStatusEmoji(status) {
    const emojis = {
        'pre-avisado': 'üîî',
        'avisado': 'üì¢',
        'en camino': 'üöó',
        'en el lugar': 'üìç',
        'finalizado': '‚úÖ'
    };
    return emojis[status] || '‚ùì';
}

function getStatusText(status) {
    const texts = {
        'pre-avisado': 'Pre-avisado',
        'avisado': 'Avisado',
        'en camino': 'En camino',
        'en el lugar': 'En el lugar',
        'finalizado': 'Finalizado'
    };
    return texts[status] || status;
}

function getStatusColors(status) {
    const colors = {
        'pre-avisado': {
            bg: '#fff3cd',
            text: '#856404',
            border: '#ffeaa7'
        },
        'avisado': {
            bg: '#d1ecf1',
            text: '#0c5460',
            border: '#bee5eb'
        },
        'en camino': {
            bg: '#e2e3e5',
            text: '#383d41',
            border: '#d6d8db'
        },
        'en el lugar': {
            bg: '#cce5ff',
            text: '#004085',
            border: '#99d6ff'
        },
        'finalizado': {
            bg: '#d4edda',
            text: '#155724',
            border: '#c3e6cb'
        }
    };
    return colors[status] || {
        bg: '#f8f9fa',
        text: '#6c757d',
        border: '#dee2e6'
    };
}

// Funci√≥n para abrir el modal de cambio de estado de asignaci√≥n
function openAssignmentStatusModal(assignmentId, indicativoNombre, currentStatus) {
    currentAssignmentForStatusChange = assignmentId;
    assignmentStatusModalTitle.textContent = `Cambiar Estado de Asignaci√≥n`;
    assignmentStatusModalInfo.textContent = `${indicativoNombre} - Estado actual: ${getStatusText(currentStatus)}`;
    
    // Resaltar el estado actual
    document.querySelectorAll('.assignment-status-change-btn').forEach(btn => {
        const btnStatus = btn.dataset.status;
        if (btnStatus === currentStatus) {
            // Estado actual - resaltado con borde m√°s grueso y sombra
            btn.style.borderWidth = '3px';
            btn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            btn.style.transform = 'scale(1.02)';
        } else {
            // Estados no actuales - estilo normal
            btn.style.borderWidth = '2px';
            btn.style.boxShadow = 'none';
            btn.style.transform = 'scale(1)';
        }
    });
    
    assignmentStatusModal.style.display = 'flex';
}

// Cerrar modal de estado
closeStatusModal.addEventListener('click', function() {
    statusChangeModal.style.display = 'none';
    currentIncidentForStatusChange = null;
});

// Event listeners para modal de asignaci√≥n
closeAssignIncidentModal.addEventListener('click', function() {
    assignIncidentModal.style.display = 'none';
    currentIncidentForAssignment = null;
});

cancelAssignBtn.addEventListener('click', function() {
    assignIncidentModal.style.display = 'none';
    currentIncidentForAssignment = null;
});

// Event listeners para modal de cambio de estado de asignaci√≥n
closeAssignmentStatusModal.addEventListener('click', function() {
    assignmentStatusModal.style.display = 'none';
    currentAssignmentForStatusChange = null;
});

// Event listener para "Asignar a" - mostrar campo libre si se selecciona "Otro"
document.getElementById('assignIndicativoSelect').addEventListener('change', function() {
    const assignOtroGroup = document.getElementById('assignOtroGroup');
    const assignOtroInput = document.getElementById('assignOtro');
    
    if (this.value === 'Otro') {
        assignOtroGroup.style.display = 'block';
        assignOtroInput.required = true;
    } else {
        assignOtroGroup.style.display = 'none';
        assignOtroInput.required = false;
        assignOtroInput.value = '';
    }
});

// Event listener para el formulario de asignaci√≥n
assignIncidentForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentIncidentForAssignment) return;
    
    // Determinar el valor final para asignar
    let assignedTo = document.getElementById('assignIndicativoSelect').value;
    if (assignedTo === 'Otro') {
        assignedTo = document.getElementById('assignOtro').value;
    }
    
    const formData = {
        indicativo_id: assignedTo,
        estado_asignacion: document.getElementById('assignStatusSelect').value
    };
    
    try {
        const response = await fetch(`/events/${eventId}/incidents/${currentIncidentForAssignment}/assignments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        });
        
        const result = await response.json();
        
        if (response.ok && result.status === 'success') {
            alert('Asignaci√≥n creada exitosamente!');
            // Recargar asignaciones actuales
            await loadCurrentAssignments(currentIncidentForAssignment);
            // Limpiar formulario
            assignIncidentForm.reset();
            document.getElementById('assignIndicativoSelect').value = '';
            document.getElementById('assignOtro').value = '';
            document.getElementById('assignOtroGroup').style.display = 'none';
            document.getElementById('assignOtro').required = false;
            document.getElementById('assignStatusSelect').value = 'avisado';
            // Recargar tabla de incidentes para mostrar nuevas asignaciones
            // Agregar un peque√±o delay para asegurar que la base de datos se actualice
            setTimeout(() => {
                loadIncidents();
            }, 500);
        } else {
            alert(`Error al crear asignaci√≥n: ${result.message || 'Error desconocido'}`);
        }
    } catch (error) {
        console.error('Error al crear asignaci√≥n:', error);
        alert('Error de red al intentar crear la asignaci√≥n.');
    }
});

// Event listeners para los botones de cambio de estado de asignaci√≥n
document.querySelectorAll('.assignment-status-change-btn').forEach(button => {
    button.addEventListener('click', async function() {
        const newStatus = this.dataset.status;
        if (!currentAssignmentForStatusChange) return;
        
        try {
            const response = await fetch(`/events/${eventId}/incidents/${currentIncidentForAssignment}/assignments/${currentAssignmentForStatusChange}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ estado_asignacion: newStatus }),
            });
            
            const result = await response.json();
            if (response.ok && result.status === 'success') {
                assignmentStatusModal.style.display = 'none';
                currentAssignmentForStatusChange = null;
                await loadCurrentAssignments(currentIncidentForAssignment);
                loadIncidents(); // Recargar tabla
            } else {
                alert(`Error al cambiar estado: ${result.message || 'Error desconocido'}`);
            }
        } catch (error) {
            console.error('Error al cambiar estado de asignaci√≥n:', error);
            alert('Error de red al intentar cambiar el estado de la asignaci√≥n.');
        }
    });
});

// Event listeners para botones de asignaciones (delegaci√≥n de eventos)
document.addEventListener('click', async function(e) {
    // Bot√≥n de eliminar asignaci√≥n
    if (e.target.classList.contains('remove-assignment-btn')) {
        const assignmentId = e.target.dataset.assignmentId;
        
        if (confirm('¬øEst√°s seguro de que quieres eliminar esta asignaci√≥n?')) {
            try {
                const response = await fetch(`/events/${eventId}/incidents/${currentIncidentForAssignment}/assignments/${assignmentId}`, {
                    method: 'DELETE',
                });
                
                const result = await response.json();
                
                
                if (response.ok && result.status === 'success') {
                    alert('Asignaci√≥n eliminada!');
                    await loadCurrentAssignments(currentIncidentForAssignment);
                    loadIncidents(); // Recargar tabla
                } else {
                    alert(`Error al eliminar asignaci√≥n: ${result.message || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error('Error al eliminar asignaci√≥n:', error);
                alert('Error de red al intentar eliminar la asignaci√≥n.');
            }
        }
    }
});

// Event listeners para los botones de cambio de estado
document.querySelectorAll('.status-change-btn').forEach(button => {
    button.addEventListener('click', async function() {
        const newStatus = this.dataset.status;
        if (!currentIncidentForStatusChange) return;
        
        try {
            const response = await fetch(`/events/${eventId}/incidents/${currentIncidentForStatusChange}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ estado: newStatus }),
            });
            
            const result = await response.json();
            if (response.ok && result.status === 'success') {
                // Si el incidente pasa a solucionado, finalizar todas las asignaciones
                if (newStatus === 'solucionado') {
                    try {
                        const assignmentsResponse = await fetch(`/events/${eventId}/incidents/${currentIncidentForStatusChange}/assignments`);
                        if (assignmentsResponse.ok) {
                            const assignmentsResult = await assignmentsResponse.json();
                            if (assignmentsResult.status === 'success' && assignmentsResult.assignments) {
                                // Finalizar todas las asignaciones que no est√©n ya finalizadas
                                const activeAssignments = assignmentsResult.assignments.filter(a => a.estado_asignacion !== 'finalizado');
                                
                                for (const assignment of activeAssignments) {
                                    try {
                                        await fetch(`/events/${eventId}/incidents/${currentIncidentForStatusChange}/assignments/${assignment.id}`, {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({ estado_asignacion: 'finalizado' }),
                                        });
                                    } catch (error) {
                                        console.error(`Error al finalizar asignaci√≥n ${assignment.id}:`, error);
                                    }
                                }
                                
                                if (activeAssignments.length > 0) {
                                    console.log(`Auto-finalizadas ${activeAssignments.length} asignaci√≥n${activeAssignments.length > 1 ? 'es' : ''} al resolver el incidente.`);
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error al auto-finalizar asignaciones:', error);
                    }
                }
                
                statusChangeModal.style.display = 'none';
                currentIncidentForStatusChange = null;
                loadIncidents(); // Recargar la lista para mostrar el nuevo estado
            } else {
                alert(`Error al cambiar estado: ${result.message || 'Error desconocido'}`);
            }
        } catch (error) {
            console.error('Error al cambiar estado del incidente:', error);
            alert('Error de red al intentar cambiar el estado del incidente.');
        }
    });
});

incidentForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Determinar el tipo final
    let tipoFinal = document.getElementById('incidentTipo').value;
    if (tipoFinal === 'Otro') {
        tipoFinal = document.getElementById('incidentTipoOtro').value;
    }
    
    // Determinar el reportado por final
    let reportadoPorFinal = document.getElementById('incidentReportadoPor').value;
    if (reportadoPorFinal === 'Otro') {
        reportadoPorFinal = document.getElementById('incidentReportadoOtro').value;
    }

    const formData = {
        tipo: tipoFinal,
        descripcion: document.getElementById('incidentDescripcion').value,
        reportado_por: reportadoPorFinal,
        lat: parseFloat(document.getElementById('incidentLat').value),
        lng: parseFloat(document.getElementById('incidentLng').value),
        info_ubicacion: document.getElementById('incidentInfoUbicacion').value || null,
        estado: document.getElementById('incidentEstado').value,
        dorsal: document.getElementById('incidentDorsal').value || null,
        patologia: document.getElementById('incidentPatologia').value || null,
    };

    if (isNaN(formData.lat) || isNaN(formData.lng)) {
        formData.lat = null;
        formData.lng = null;
    }

    if (!formData.dorsal) delete formData.dorsal;
    if (!formData.patologia) delete formData.patologia;

    // Determinar si es creaci√≥n (POST) o actualizaci√≥n (PUT)
    let url = `/events/${eventId}/incidents`;
    let method = 'POST';
    if (editingIncidentId) {
        url += `/${editingIncidentId}`;
        method = 'PUT';
    }

    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        });

        const result = await response.json();

        if (response.ok && result.status === 'success') {
            alert(`Incidente ${editingIncidentId ? 'actualizado' : 'creado'} exitosamente!`);
            incidentModal.style.display = 'none';
            incidentForm.reset(); // Limpiar formulario
            editingIncidentId = null; // Resetear modo edici√≥n y el ID
            if (incidentMarker) {
                incidentMap.removeLayer(incidentMarker);
                incidentMarker = null;
            }
            loadIncidents(); // Recargar la lista de incidentes
        } else {
            alert(`Error al ${editingIncidentId ? 'actualizar' : 'crear'} incidente: ${result.message || 'Error desconocido'}`);
        }
    } catch (error) {
        console.error(`Error en la petici√≥n de ${editingIncidentId ? 'actualizar' : 'crear'} incidente:`, error);
        alert(`Error de red al intentar ${editingIncidentId ? 'actualizar' : 'crear'} el incidente.`);
    }
});

// Event listener para botones de acci√≥n en la tabla de incidentes (ej. eliminar)
document.getElementById('incidentsTableBody').addEventListener('click', async function(e) {
    if (e.target.classList.contains('delete-incident-btn')) {
        const incidentId = e.target.dataset.id;
        if (confirm(`¬øEst√°s seguro de que quieres eliminar el incidente ID ${incidentId}? Esta acci√≥n no se puede deshacer directamente.`)) {
            try {
                const response = await fetch(`/events/${eventId}/incidents/${incidentId}`, {
                    method: 'DELETE',
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    alert('Incidente eliminado (marcado como tal).');
                    loadIncidents(); // Recargar la lista
                } else {
                    alert(`Error al eliminar incidente: ${result.message || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error('Error de red al eliminar incidente:', error);
                alert('Error de red al intentar eliminar el incidente.');
            }
        }
    }
    // Bot√≥n de Editar Incidente
    else if (e.target.classList.contains('edit-incident-btn')) {
        const incidentId = e.target.dataset.id;
        openIncidentModalForEdit(incidentId);
    }
    // Bot√≥n de Asignar Incidente
    else if (e.target.classList.contains('assign-incident-btn')) {
        const incidentId = e.target.dataset.id;
        openAssignIncidentModal(incidentId);
    }
    // Bot√≥n de Restaurar Incidente
    else if (e.target.classList.contains('restore-incident-btn')) {
        const incidentId = e.target.dataset.id;
        if (confirm(`¬øEst√°s seguro de que quieres restaurar el incidente ID ${incidentId}?`)) {
            try {
                const response = await fetch(`/events/${eventId}/incidents/${incidentId}/restore`, {
                    method: 'POST',
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    alert('Incidente restaurado exitosamente.');
                    loadIncidents(); // Recargar la lista
                } else {
                    alert(`Error al restaurar incidente: ${result.message || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error('Error de red al restaurar incidente:', error);
                alert('Error de red al intentar restaurar el incidente.');
            }
        }
    }

});

// TODO: L√≥gica para cargar incidentes, enviar formulario (crear/editar), etc.
// Event listeners para filtros y b√∫squeda
document.addEventListener('DOMContentLoaded', function() {
    loadIncidents();
    
    // Buscador general con debounce
    let searchTimeout;
    document.getElementById('incidentSearch').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterAndSortIncidents, 300);
    });
    
    // Filtros por estado y tipo
    document.getElementById('statusFilter').addEventListener('change', filterAndSortIncidents);
    document.getElementById('typeFilter').addEventListener('change', filterAndSortIncidents);
    
    // Controles de ordenaci√≥n
    document.getElementById('sortField').addEventListener('change', filterAndSortIncidents);
    document.getElementById('sortOrder').addEventListener('change', filterAndSortIncidents);
    
    // Bot√≥n limpiar filtros
    document.getElementById('clearFiltersBtn').addEventListener('click', function() {
        document.getElementById('incidentSearch').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('typeFilter').value = '';
        document.getElementById('sortField').value = 'incident_number';
        document.getElementById('sortOrder').value = 'asc';
        filterAndSortIncidents();
    });
    
    // Event listeners para botones de estado del incidente
    document.querySelectorAll('.incident-status-btn').forEach(button => {
        button.addEventListener('click', function() {
            const selectedStatus = this.dataset.status;
            
            // Actualizar campo hidden
            document.getElementById('incidentEstado').value = selectedStatus;
            
            // Actualizar estilos visuales
            document.querySelectorAll('.incident-status-btn').forEach(btn => {
                if (btn.dataset.status === selectedStatus) {
                    btn.classList.add('current-status');
                } else {
                    btn.classList.remove('current-status');
                }
            });
        });
    });
    
    // Event listeners para botones de estado de asignaci√≥n
    document.querySelectorAll('.assignment-status-btn').forEach(button => {
        button.addEventListener('click', function() {
            const selectedStatus = this.dataset.status;
            
            // Actualizar campo hidden
            document.getElementById('assignStatusSelect').value = selectedStatus;
            
            // Actualizar estilos visuales
            document.querySelectorAll('.assignment-status-btn').forEach(btn => {
                if (btn.dataset.status === selectedStatus) {
                    btn.classList.add('current-status');
                } else {
                    btn.classList.remove('current-status');
                }
            });
        });
    });
    
    // Establecer estado inicial por defecto
    setIncidentStatus('activo');
    setAssignmentStatus('avisado');
});

// Funci√≥n para establecer estado inicial del incidente
function setIncidentStatus(status) {
    document.getElementById('incidentEstado').value = status;
    document.querySelectorAll('.incident-status-btn').forEach(btn => {
        if (btn.dataset.status === status) {
            btn.classList.add('current-status');
        } else {
            btn.classList.remove('current-status');
        }
    });
}

// Funci√≥n para establecer estado de asignaci√≥n
function setAssignmentStatus(status) {
    document.getElementById('assignStatusSelect').value = status;
    document.querySelectorAll('.assignment-status-btn').forEach(btn => {
        if (btn.dataset.status === status) {
            btn.classList.add('current-status');
        } else {
            btn.classList.remove('current-status');
        }
    });
}

// Listener para el bot√≥n de b√∫squeda de direcci√≥n en el modal de incidentes
incidentSearchAddressBtn.addEventListener('click', async function() {
    const address = incidentAddressSearchInput.value.trim();
    if (!address) return alert('Por favor, introduce una direcci√≥n para buscar.');

    let searchQuery = address;
    if (eventZona) {
        searchQuery += ", " + eventZona; // A√±adir la zona del evento a la b√∫squeda para dar contexto
    }

    try {
        const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`;
        // const response = await fetch(searchUrl, { headers: { 'User-Agent': 'RCQEventsClient/1.0' } }); // Cambia el User-Agent
        // Para evitar problemas de CORS si Nominatim es estricto, o para simplificar, si el navegador no bloquea por User-Agent:
        const response = await fetch(searchUrl);
        if (!response.ok) throw new Error(`Error HTTP de Nominatim: ${response.status}`);
        const results = await response.json();

        if (results && results.length > 0) {
            const { lat, lon, display_name } = results[0];
            const parsedLat = parseFloat(lat);
            const parsedLng = parseFloat(lon);
            
            if (incidentMap) {
                incidentMap.setView([parsedLat, parsedLng], 16); // Centrar mapa y hacer zoom
                await setIncidentMarker(parsedLat, parsedLng); // Pone el marcador y actualiza campos Lat/Lng y direcci√≥n
            }
            incidentAddressSearchInput.value = ''; // Limpiar input de b√∫squeda
        } else {
            alert('Direcci√≥n no encontrada. Prueba con m√°s detalles o una direcci√≥n diferente.');
            document.getElementById('incidentAddressDisplay').textContent = 'Direcci√≥n no encontrada.';
        }
    } catch (error) {
        console.error('Error al buscar direcci√≥n:', error);
        alert('Error de red o del servicio de geocodificaci√≥n al buscar la direcci√≥n.');
        document.getElementById('incidentAddressDisplay').textContent = 'Error al buscar direcci√≥n.';
    }
});

// Tambi√©n permitir b√∫squeda con Enter en el input de direcci√≥n
incidentAddressSearchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault(); // Evitar submit del formulario si estuviera dentro de uno
        incidentSearchAddressBtn.click(); // Simular clic en el bot√≥n de b√∫squeda
    }
});

// --- FUNCIONALIDAD GLOBAL: CERRAR MODALES CON ESCAPE Y CLICK FUERA ---
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAllModals();
    }
});

// Funci√≥n para cerrar todos los modales
function closeAllModals() {
    // Cerrar modal de incidentes
    if (incidentModal.style.display === 'flex') {
        incidentModal.style.display = 'none';
        if (incidentMarker) {
            incidentMap.removeLayer(incidentMarker);
            incidentMarker = null;
        }
        editingIncidentId = null;
        // Limpiar campos de texto libre
        document.getElementById('tipoOtroGroup').style.display = 'none';
        document.getElementById('reportadoOtroGroup').style.display = 'none';
        document.getElementById('incidentTipoOtro').value = '';
        document.getElementById('incidentReportadoOtro').value = '';
        document.getElementById('incidentTipoOtro').required = false;
        document.getElementById('incidentReportadoOtro').required = false;
    }
    
    // Cerrar modal de cambio de estado
    if (statusChangeModal.style.display === 'flex') {
        statusChangeModal.style.display = 'none';
        currentIncidentForStatusChange = null;
    }
    
    // Cerrar modal de coordenadas
    if (coordsModal.style.display === 'flex') {
        coordsModal.style.display = 'none';
    }
    
    // Cerrar modal de ubicaci√≥n manual
    if (locationModal.style.display === 'flex') {
        locationModal.style.display = 'none';
    }
    
    // Cerrar modal de asignar servicio
    if (assignServiceModal.style.display === 'flex') {
        assignServiceModal.style.display = 'none';
    }
    
    // Cerrar modal de asignaci√≥n de incidentes
    if (assignIncidentModal.style.display === 'flex') {
        assignIncidentModal.style.display = 'none';
        currentIncidentForAssignment = null;
    }
    
    // Cerrar modal de cambio de estado de asignaci√≥n
    if (assignmentStatusModal.style.display === 'flex') {
        assignmentStatusModal.style.display = 'none';
        currentAssignmentForStatusChange = null;
    }
    
    // Cerrar modal r√°pido de cambio de estado de asignaci√≥n
    if (document.getElementById('quickAssignmentStatusModal').style.display === 'flex') {
        document.getElementById('quickAssignmentStatusModal').style.display = 'none';
        currentAssignmentForStatusChange = null;
    }
}

// Click fuera del modal para cerrar
document.addEventListener('click', function(e) {
    // Modal de incidentes
    if (incidentModal.style.display === 'flex' && e.target === incidentModal) {
        incidentModal.style.display = 'none';
        if (incidentMarker) {
            incidentMap.removeLayer(incidentMarker);
            incidentMarker = null;
        }
        editingIncidentId = null;
        // Limpiar campos de texto libre
        document.getElementById('tipoOtroGroup').style.display = 'none';
        document.getElementById('reportadoOtroGroup').style.display = 'none';
        document.getElementById('incidentTipoOtro').value = '';
        document.getElementById('incidentReportadoOtro').value = '';
        document.getElementById('incidentTipoOtro').required = false;
        document.getElementById('incidentReportadoOtro').required = false;
    }
    
    // Modal de cambio de estado
    if (statusChangeModal.style.display === 'flex' && e.target === statusChangeModal) {
        statusChangeModal.style.display = 'none';
        currentIncidentForStatusChange = null;
    }
    
    // Modal de coordenadas
    if (coordsModal.style.display === 'flex' && e.target === coordsModal) {
        coordsModal.style.display = 'none';
    }
    
    // Modal de ubicaci√≥n manual
    if (locationModal.style.display === 'flex' && e.target === locationModal) {
        locationModal.style.display = 'none';
    }
    
    // Modal de asignar servicio
    if (assignServiceModal.style.display === 'flex' && e.target === assignServiceModal) {
        assignServiceModal.style.display = 'none';
    }
    
    // Modal de asignaci√≥n de incidentes
    if (assignIncidentModal.style.display === 'flex' && e.target === assignIncidentModal) {
        assignIncidentModal.style.display = 'none';
        currentIncidentForAssignment = null;
    }
    
    // Modal de cambio de estado de asignaci√≥n
    if (assignmentStatusModal.style.display === 'flex' && e.target === assignmentStatusModal) {
        assignmentStatusModal.style.display = 'none';
        currentAssignmentForStatusChange = null;
    }
    
    // Modal r√°pido de cambio de estado de asignaci√≥n
    if (document.getElementById('quickAssignmentStatusModal').style.display === 'flex' && e.target === document.getElementById('quickAssignmentStatusModal')) {
        document.getElementById('quickAssignmentStatusModal').style.display = 'none';
        currentAssignmentForStatusChange = null;
    }
});

// --- MODAL DE COORDENADAS AVANZADAS ---
const showCoordsBtn = document.getElementById('showCoordsBtn');
const coordsModal = document.getElementById('coordsModal');
const closeCoordsModal = document.getElementById('closeCoordsModal');
const coordsLatInput = document.getElementById('coordsLatInput');
const coordsLngInput = document.getElementById('coordsLngInput');
const clearCoordsBtn = document.getElementById('clearCoordsBtn');
const applyCoordsBtn = document.getElementById('applyCoordsBtn');

// Abrir modal de coordenadas
showCoordsBtn.addEventListener('click', function() {
    // Poblar con valores actuales
    coordsLatInput.value = document.getElementById('incidentLat').value || '';
    coordsLngInput.value = document.getElementById('incidentLng').value || '';
    coordsModal.style.display = 'flex';
});

// Cerrar modal de coordenadas
closeCoordsModal.addEventListener('click', function() {
    coordsModal.style.display = 'none';
});

// Limpiar coordenadas
clearCoordsBtn.addEventListener('click', function() {
    coordsLatInput.value = '';
    coordsLngInput.value = '';
    document.getElementById('incidentLat').value = '';
    document.getElementById('incidentLng').value = '';
    // Limpiar marcador del mapa
    if (incidentMarker) {
        incidentMap.removeLayer(incidentMarker);
        incidentMarker = null;
    }
    document.getElementById('incidentAddressDisplay').textContent = '';
    coordsModal.style.display = 'none';
});

// Aplicar coordenadas
applyCoordsBtn.addEventListener('click', async function() {
    const lat = parseFloat(coordsLatInput.value);
    const lng = parseFloat(coordsLngInput.value);
    
    if (!isNaN(lat) && !isNaN(lng)) {
        document.getElementById('incidentLat').value = lat;
        document.getElementById('incidentLng').value = lng;
        
        // Actualizar mapa y marcador
        if (incidentMap) {
            incidentMap.setView([lat, lng], 15);
            await setIncidentMarker(lat, lng); // Esperar a que se actualice la direcci√≥n
        }
        
        coordsModal.style.display = 'none';
    } else {
        alert('Por favor, introduce valores v√°lidos para latitud y longitud.');
    }
});

// Funci√≥n para abrir el modal r√°pido de cambio de estado de asignaci√≥n
function openQuickAssignmentStatusModal(assignmentId, assignmentName, currentStatus, incidentId, incidentNumber, incidentType, incidentDorsal) {
    currentAssignmentForStatusChange = assignmentId;
    currentIncidentForAssignment = incidentId; // Para recargar despu√©s
    
    const modal = document.getElementById('quickAssignmentStatusModal');
    const title = document.getElementById('quickAssignmentStatusTitle');
    const info = document.getElementById('quickAssignmentStatusInfo');
    
    title.textContent = 'Cambiar Estado de Asignaci√≥n';
    
    // Construir informaci√≥n del incidente
    let incidentInfo = `Incidente #${incidentNumber} - ${incidentType}`;
    
    // A√±adir dorsal si es asistencia m√©dica y tiene dorsal
    if (incidentType === 'üöë Asistencia M√©dica' && incidentDorsal && incidentDorsal.trim() !== '') {
        incidentInfo += ` (Dorsal: ${incidentDorsal})`;
    }
    
    incidentInfo += `\nAsignado a: ${assignmentName}`;
    
    info.textContent = incidentInfo;
    info.style.whiteSpace = 'pre-line'; // Para que respete los saltos de l√≠nea
    
    // Resaltar el estado actual en los botones de forma mucho m√°s prominente
    document.querySelectorAll('.quick-status-btn').forEach(btn => {
        const btnStatus = btn.dataset.status;
        if (btnStatus === currentStatus) {
            // Estado actual - resaltado muy prominente
            btn.style.borderWidth = '4px';
            btn.style.boxShadow = '0 8px 16px rgba(0,0,0,0.3), inset 0 0 0 2px rgba(255,255,255,0.8)';
            btn.style.transform = 'scale(1.08)';
            btn.style.fontWeight = '900';
            btn.style.position = 'relative';
            btn.style.zIndex = '10';
        } else {
            // Estados no actuales - estilo normal
            btn.style.borderWidth = '2px';
            btn.style.boxShadow = 'none';
            btn.style.transform = 'scale(1)';
            btn.style.fontWeight = 'bold';
            btn.style.position = 'relative';
            btn.style.zIndex = '1';
        }
    });
    
    modal.style.display = 'flex';
}

// Funci√≥n para cambiar estado de asignaci√≥n r√°pidamente
async function changeAssignmentStatusQuick(newStatus) {
    if (!currentAssignmentForStatusChange) return;
    
    try {
        const response = await fetch(`/events/${eventId}/incidents/${currentIncidentForAssignment}/assignments/${currentAssignmentForStatusChange}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                estado_asignacion: newStatus
            }),
        });
        
        const result = await response.json();
        
        if (response.ok && result.status === 'success') {
            // Cerrar modal
            document.getElementById('quickAssignmentStatusModal').style.display = 'none';
            currentAssignmentForStatusChange = null;
            
            // Recargar incidentes para mostrar el cambio
            setTimeout(() => {
                loadIncidents();
            }, 300);
        } else {
            alert(`Error al cambiar estado: ${result.message || 'Error desconocido'}`);
        }
    } catch (error) {
        console.error('Error al cambiar estado de asignaci√≥n:', error);
        alert('Error de red al intentar cambiar el estado.');
    }
}
</script>
</body>
</html>
